<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qgo Cargo - Crew & Inventory Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Custom Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for Qgo Cargo branding */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f7; /* Lighter blue-gray background */
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        /* Style for active navigation link */
        .nav-link.active {
            background-color: #2c5282; /* Dark blue */
            color: white;
            font-weight: 600;
        }
        /* Card styling */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1rem;
        }
        @media (min-width: 640px) {
            .card {
                padding: 1.5rem;
            }
        }
        /* Button styling */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: #3182ce; /* Qgo Blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2b6cb0;
        }
        .btn-secondary {
            background-color: #718096;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4a5568;
        }
        .btn-danger {
            background-color: #e53e3e;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c53030;
        }
        .btn-success {
             background-color: #38a169;
             color: white;
        }
        .btn-success:hover {
            background-color: #2f855a;
        }
        /* Details/Summary styling for user profiles */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        
        /* Floating Testing Tool Styles */
        #floating-test-tool {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border-radius: 50%;
            cursor: move;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        #floating-test-tool:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        #test-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 10001;
            display: none;
            overflow: hidden;
        }

        .panel-header {
            background: #4CAF50;
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .feature-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }

        .feature-input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .feature-textarea {
            width: 100%;
            height: 80px;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        .highlight-overlay {
            position: fixed;
            border: 3px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            pointer-events: none;
            z-index: 9998;
        }

        .btn-info {
            background-color: #2196F3;
            color: white;
        }

        .btn-info:hover {
            background-color: #1976D2;
        }

        .btn-warning {
            background-color: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background-color: #f57c00;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
    </div>
    
    <!-- Authentication Screen -->
    <div id="auth-container" class="w-full min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <!-- Login Form -->
            <div id="login-card" class="card">
                 <div class="text-3xl font-bold text-blue-700 mb-6 text-center flex items-center justify-center gap-2">
                     <i data-feather="truck"></i>
                     <span>Qgo Cargo</span>
                 </div>
                <h2 class="text-xl font-bold text-center mb-6 text-gray-700">Login to your Account</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" name="email" required class="w-full border rounded-md p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" name="password" required class="w-full border rounded-md p-2">
                    </div>
                    <button type="submit" class="btn btn-primary w-full !mt-6">Login</button>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-2"></p>
                </form>
                <p class="text-center text-sm mt-4">
                    Don't have an account? <a href="#" id="show-register" class="font-medium text-blue-600 hover:underline">Register here</a>
                </p>
            </div>
            <!-- Registration Form -->
            <div id="register-card" class="card hidden">
                 <div class="text-3xl font-bold text-blue-700 mb-6 text-center flex items-center justify-center gap-2">
                     <i data-feather="truck"></i>
                     <span>Qgo Cargo</span>
                 </div>
                <h2 class="text-xl font-bold text-center mb-6 text-gray-700">Create an Account</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" name="email" required class="w-full border rounded-md p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" name="password" required class="w-full border rounded-md p-2">
                    </div>
                    <button type="submit" class="btn btn-primary w-full !mt-6">Register</button>
                    <p id="register-error" class="text-red-500 text-sm text-center mt-2"></p>
                </form>
                <p class="text-center text-sm mt-4">
                    Already have an account? <a href="#" id="show-login" class="font-medium text-blue-600 hover:underline">Login here</a>
                </p>
            </div>
             <!-- Pending Approval Screen -->
            <div id="pending-approval-card" class="card hidden text-center">
                <i data-feather="clock" class="w-16 h-16 text-yellow-500 mx-auto mb-4"></i>
                <h2 class="text-2xl font-bold text-center mb-4">Pending Approval</h2>
                <p class="text-gray-600">Your account has been created successfully. An administrator must approve your account before you can log in.</p>
                <button id="back-to-login" class="btn btn-primary w-full mt-6">Back to Login</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden h-screen overflow-hidden">
        <div class="flex h-full">
            <!-- Sidebar Navigation -->
            <aside id="sidebar" class="sidebar bg-white w-64 min-h-full p-4 shadow-lg fixed lg:relative transform -translate-x-full lg:translate-x-0 z-40">
                <div class="text-3xl font-bold text-blue-700 mb-8 flex items-center gap-2">
                    <img src="https://qgocargo.com/logo.png" alt="Qgo Cargo Logo" class="h-10 w-10" onerror="this.style.display='none'">
                    <span>Qgo Cargo</span>
                </div>
                <nav id="app-nav">
                    <ul>
                        <li><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 active" data-tab="analytics"><i data-feather="bar-chart-2" class="mr-3"></i>Analytics</a></li>
                        <li><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 mt-2" data-tab="scheduling"><i data-feather="calendar" class="mr-3"></i>Scheduling</a></li>
                        <li><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 mt-2" data-tab="inventory"><i data-feather="archive" class="mr-3"></i>Inventory</a></li>
                        <li><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 mt-2" data-tab="reports"><i data-feather="file-text" class="mr-3"></i>Reports</a></li>
                        <li><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 mt-2" data-tab="maintenance"><i data-feather="tool" class="mr-3"></i>Maintenance</a></li>
                        <li><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 mt-2" data-tab="admin"><i data-feather="shield" class="mr-3"></i>Admin Panel</a></li>
                        <li><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 mt-2" data-tab="notifications"><i data-feather="bell" class="mr-3"></i>Notifications</a></li>
                        <li id="testing-tab-link" class="hidden"><a href="#" class="nav-link flex items-center p-3 rounded-lg text-gray-700 hover:bg-blue-800 hover:text-white transition-colors duration-200 mt-2" data-tab="testing"><i data-feather="check-circle" class="mr-3"></i>Testing</a></li>

                    </ul>
                </nav>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="main-content flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
                <header class="flex justify-between items-center mb-6">
                    <button id="menu-toggle" class="lg:hidden p-2 rounded-md hover:bg-gray-200">
                        <i data-feather="menu"></i>
                    </button>
                    <h1 id="tab-title" class="text-2xl sm:text-3xl font-bold text-gray-800">Analytics Dashboard</h1>
                    <div class="flex items-center gap-4">
                        <span id="user-info" class="text-sm font-medium hidden sm:block"></span>
                        <button id="switch-user-btn" class="btn btn-primary !bg-purple-600 hover:!bg-purple-700 !p-2"><i data-feather="users"></i><span class="hidden sm:inline ml-2">Switch User</span></button>
                        <button id="logout-btn" class="btn btn-secondary !p-2"><i data-feather="log-out"></i><span class="hidden sm:inline ml-2">Logout</span></button>
                    </div>
                </header>

                <!-- Tab Content -->
                <div id="analytics-tab" class="tab-content hidden"></div>
                <div id="scheduling-tab" class="tab-content hidden"></div>
                <div id="inventory-tab" class="tab-content hidden"></div>
                <div id="reports-tab" class="tab-content hidden"></div>
                <div id="maintenance-tab" class="tab-content hidden"></div>
                <div id="admin-tab" class="tab-content hidden"></div>
                <div id="notifications-tab" class="tab-content hidden"></div>
                <div id="testing-tab" class="tab-content hidden"></div>

            </main>
        </div>
    </div>

    <!-- Floating Testing Tool -->
    <div id="floating-test-tool" onclick="toggleTestPanel()" style="
        position: fixed; top: 20px; right: 20px; width: 60px; height: 60px;
        background: linear-gradient(45deg, #4CAF50, #45a049); border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: white; font-size: 24px; cursor: pointer; z-index: 10000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    ">🔧</div>

    <div id="test-panel" style="
        position: fixed; top: 100px; right: 20px; width: 350px;
        background: white; border-radius: 10px; display: none;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 10001; overflow: hidden;
    ">
        <div style="background: #4CAF50; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>Qgo Cargo Testing Tool</span>
            <button onclick="closeTestPanel()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">×</button>
        </div>
        <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
            <div style="margin-bottom: 15px; padding: 10px; border: 2px dashed #ddd; border-radius: 5px; background: #f9f9f9;">
                <h4>Testing Session</h4>
                <input type="text" id="feature-name" placeholder="Feature Name (e.g., Labour Profile, Email Field)" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                <textarea id="issue-description" placeholder="Describe the issue or change needed..." style="width: 100%; height: 60px; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                <select id="issue-type" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="bug">Bug Report</option>
                    <option value="change">Change Request</option>
                    <option value="enhancement">Enhancement</option>
                    <option value="ui-issue">UI Issue</option>
                </select>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button onclick="startElementCapture()" style="background-color: #2196F3; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">📍 Point & Capture</button>
                    <button onclick="startContinuousCapture()" style="background-color: #9C27B0; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">🔄 Multi-Click</button>
                    <button onclick="addToSession()" style="background-color: #ff9800; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">➕ Add to Session</button>
                    <button onclick="saveTestReport()" style="background-color: #3182ce; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">💾 Save Report</button>
                    <button onclick="clearSession()" style="background-color: #e53e3e; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">�️ Clear Session</button>
                </div>
                <div id="session-counter" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
            </div>
            
            <div id="current-session" style="margin-bottom: 15px; padding: 10px; border: 2px solid #4CAF50; border-radius: 5px; background: #f0fff0; display: none;">
                <h4 style="color: #2e7d32;">Current Session Items (<span id="session-count">0</span>)</h4>
                <div id="session-items" style="max-height: 150px; overflow-y: auto;"></div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; border: 2px dashed #ddd; border-radius: 5px; background: #f9f9f9;">
                <h4>Element Info</h4>
                <div id="element-info" style="font-size: 12px; color: #666;">
                    Click "Point & Capture" and then click on any element
                </div>
            </div>

            <div style="margin-bottom: 15px; padding: 10px; border: 2px dashed #ddd; border-radius: 5px; background: #f9f9f9;">
                <h4>Saved Reports (Total: <span id="test-report-count">0</span>)</h4>
                <button onclick="exportTestReports()" style="background-color: #ff9800; color: white; padding: 8px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer;">📄 Export All Reports</button>
                <button onclick="clearTestReports()" style="background-color: #e53e3e; color: white; padding: 8px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer;">🗑️ Clear All</button>
                <div id="test-reports-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Forms -->
    <div id="form-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 sm:p-8 transform transition-all scale-95 opacity-0 max-h-[90vh] overflow-y-auto">
            <!-- Modal content will be injected here -->
        </div>
    </div>


    <!-- Testing Tool Functions - Global Scope -->
    <script>
        // Global testing tool variables and functions
        let testingReports = JSON.parse(localStorage.getItem('qgoCargoTestReports') || '[]');
        let isCapturingElement = false;
        let continuousCapture = false;
        let capturedElement = null;
        let currentSession = [];
        let sessionId = null;

        function toggleTestPanel() {
            const panel = document.getElementById('test-panel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                updateTestReportsList();
            } else {
                panel.style.display = 'none';
            }
        }

        function closeTestPanel() {
            document.getElementById('test-panel').style.display = 'none';
        }

        function startElementCapture() {
            isCapturingElement = true;
            document.body.style.cursor = 'crosshair';
            
            // Add instruction overlay
            const instruction = document.createElement('div');
            instruction.id = 'capture-instruction';
            const bgColor = continuousCapture ? '#9C27B0' : '#ff4444';
            const message = continuousCapture ? 
                'CONTINUOUS MODE: Click multiple elements, ESC to stop' : 
                'Click on any element to capture it (ESC to cancel)';
            
            instruction.style.cssText = `
                position: fixed; top: 10px; left: 50%;
                transform: translateX(-50%); background: ${bgColor};
                color: white; padding: 10px 20px; border-radius: 20px;
                z-index: 10002; font-weight: bold;
            `;
            instruction.textContent = message;
            document.body.appendChild(instruction);

            function captureHandler(e) {
                if (isCapturingElement && !e.target.closest('#test-panel') && !e.target.closest('#floating-test-tool')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    capturedElement = e.target;
                    analyzeElement(e.target);
                    
                    if (continuousCapture) {
                        // In continuous mode, automatically add to session without asking for details
                        quickAddToSession();
                        
                        // Update instruction for next capture
                        const inst = document.getElementById('capture-instruction');
                        if (inst) {
                            inst.textContent = `Captured ${currentSession.length} element(s). Click next element or ESC to stop.`;
                            inst.style.backgroundColor = '#4CAF50'; // Green for success
                            setTimeout(() => {
                                if (inst) {
                                    inst.textContent = 'Click on next element to capture (ESC to stop continuous capture)';
                                    inst.style.backgroundColor = '#9C27B0'; // Purple for continuous mode
                                }
                            }, 1500);
                        }
                    } else {
                        // Single capture mode - stop capturing
                        isCapturingElement = false;
                        document.body.style.cursor = 'default';
                        
                        const inst = document.getElementById('capture-instruction');
                        if (inst) inst.remove();
                        
                        document.removeEventListener('click', captureHandler, true);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                }
            }

            function escapeHandler(e) {
                if (e.key === 'Escape') {
                    isCapturingElement = false;
                    continuousCapture = false;
                    document.body.style.cursor = 'default';
                    const inst = document.getElementById('capture-instruction');
                    if (inst) inst.remove();
                    document.removeEventListener('click', captureHandler, true);
                    document.removeEventListener('keydown', escapeHandler);
                    
                    // Show bulk editing interface for continuous mode
                    if (currentSession.length > 0) {
                        showBulkEditDialog();
                    }
                }
            }

            document.addEventListener('click', captureHandler, true);
            document.addEventListener('keydown', escapeHandler);
        }

        function startContinuousCapture() {
            continuousCapture = true;
            startElementCapture();
        }

        function analyzeElement(element) {
            const rect = element.getBoundingClientRect();
            
            const elementInfo = {
                tagName: element.tagName.toLowerCase(),
                id: element.id || 'No ID',
                className: element.className || 'No classes',
                text: element.textContent?.trim().substring(0, 100) || 'No text',
                position: { top: rect.top, left: rect.left, width: rect.width, height: rect.height },
                xpath: getElementXPath(element),
                cssSelector: getElementCSSSelector(element)
            };

            displayElementInfo(elementInfo);
            highlightElement(element);
        }

        function getElementXPath(element) {
            if (!element || element.nodeType !== 1) return '';
            if (element.id) return `//*[@id="${element.id}"]`;
            
            const parts = [];
            while (element && element.nodeType === 1) {
                let index = 0;
                let sibling = element.previousSibling;
                while (sibling) {
                    if (sibling.nodeType === 1 && sibling.tagName === element.tagName) index++;
                    sibling = sibling.previousSibling;
                }
                const tagName = element.tagName.toLowerCase();
                const pathIndex = index > 0 ? `[${index + 1}]` : '';
                parts.unshift(`${tagName}${pathIndex}`);
                element = element.parentElement;
                if (parts.length > 5) break;
            }
            return '/' + parts.join('/');
        }

        function getElementCSSSelector(element) {
            if (element.id) return `#${element.id}`;
            const parts = [];
            while (element && element.nodeType === 1) {
                let selector = element.tagName.toLowerCase();
                if (element.className) {
                    selector += '.' + element.className.trim().split(/\s+/).join('.');
                }
                parts.unshift(selector);
                element = element.parentElement;
                if (parts.length > 3) break;
            }
            return parts.join(' > ');
        }

        function highlightElement(element) {
            document.querySelectorAll('.highlight-overlay').forEach(el => el.remove());
            const rect = element.getBoundingClientRect();
            const highlight = document.createElement('div');
            highlight.className = 'highlight-overlay';
            highlight.style.cssText = `
                position: fixed; border: 3px solid #ff0000; background: rgba(255, 0, 0, 0.1);
                pointer-events: none; z-index: 9998;
                top: ${rect.top + window.scrollY}px; left: ${rect.left + window.scrollX}px;
                width: ${rect.width}px; height: ${rect.height}px;
            `;
            document.body.appendChild(highlight);
            setTimeout(() => { if (highlight.parentNode) highlight.parentNode.removeChild(highlight); }, 3000);
        }

        function displayElementInfo(info) {
            const elementInfoDiv = document.getElementById('element-info');
            elementInfoDiv.innerHTML = `
                <strong>Captured Element:</strong><br>
                <strong>Tag:</strong> ${info.tagName}<br>
                <strong>ID:</strong> ${info.id}<br>
                <strong>Classes:</strong> ${info.className}<br>
                <strong>Text:</strong> ${info.text}<br>
                <strong>Position:</strong> ${Math.round(info.position.left)}, ${Math.round(info.position.top)}<br>
                <strong>Size:</strong> ${Math.round(info.position.width)} x ${Math.round(info.position.height)}<br>
                <strong>CSS Selector:</strong><br><code style="font-size:10px;">${info.cssSelector}</code><br>
                <strong>XPath:</strong><br><code style="font-size:10px;">${info.xpath}</code>
            `;
        }

        function saveTestReport() {
            // Check if we have session items or single item
            if (currentSession.length > 0) {
                // Save as session report
                const sessionReport = {
                    id: Date.now(),
                    sessionId: sessionId,
                    timestamp: new Date().toLocaleString(),
                    type: 'multi_capture_session',
                    totalItems: currentSession.length,
                    sessionItems: currentSession,
                    currentTab: document.querySelector('.nav-link.active')?.textContent || 'Unknown Tab',
                    pageInfo: { url: window.location.href, title: document.title },
                    summary: {
                        bugReports: currentSession.filter(item => item.issueType === 'bug').length,
                        changeRequests: currentSession.filter(item => item.issueType === 'change').length,
                        enhancements: currentSession.filter(item => item.issueType === 'enhancement').length,
                        uiIssues: currentSession.filter(item => item.issueType === 'ui-issue').length
                    },
                    aiPrompt: generateSessionAIPrompt(currentSession)
                };

                testingReports.push(trackChangesInReport(sessionReport));
                
                // Clear session after saving
                currentSession = [];
                sessionId = null;
                updateSessionDisplay();
                
                alert(`Session report saved with ${sessionReport.totalItems} items!`);
            } else {
                // Save single item report
                const featureName = document.getElementById('feature-name').value.trim();
                const issueDescription = document.getElementById('issue-description').value.trim();
                const issueType = document.getElementById('issue-type').value;

                if (!featureName || !issueDescription) {
                    alert('Please fill in feature name and description');
                    return;
                }

                const report = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    type: 'single_item',
                    featureName, issueDescription, issueType,
                    currentTab: document.querySelector('.nav-link.active')?.textContent || 'Unknown Tab',
                    elementInfo: capturedElement ? {
                        tagName: capturedElement.tagName.toLowerCase(),
                        id: capturedElement.id || 'No ID',
                        className: capturedElement.className || 'No classes',
                        text: capturedElement.textContent?.trim().substring(0, 200) || 'No text',
                        xpath: getElementXPath(capturedElement),
                        cssSelector: getElementCSSSelector(capturedElement),
                        beforeState: captureElementState(capturedElement)
                    } : null,
                    pageInfo: { url: window.location.href, title: document.title },
                    aiPrompt: generateAIPrompt({ featureName, issueDescription, issueType, currentTab: document.querySelector('.nav-link.active')?.textContent || 'Unknown Tab', elementInfo: capturedElement ? { tagName: capturedElement.tagName.toLowerCase(), id: capturedElement.id || 'No ID', className: capturedElement.className || 'No classes', xpath: getElementXPath(capturedElement), cssSelector: getElementCSSSelector(capturedElement) } : null })
                };

                testingReports.push(trackChangesInReport(report));
                alert('Single test report saved successfully!');
            }

            localStorage.setItem('qgoCargoTestReports', JSON.stringify(testingReports));
            
            document.getElementById('feature-name').value = '';
            document.getElementById('issue-description').value = '';
            document.getElementById('element-info').innerHTML = 'Click "Point & Capture" and then click on any element';
            capturedElement = null;

            updateTestReportsList();
        }

        function generateSessionAIPrompt(sessionItems) {
            const summary = sessionItems.reduce((acc, item) => {
                acc[item.issueType] = (acc[item.issueType] || 0) + 1;
                return acc;
            }, {});

            let prompt = `
QIGO CARGO APPLICATION - MULTI-CAPTURE TESTING SESSION REPORT:

Application: Qgo Cargo - Crew & Inventory Management System
Session Date: ${new Date().toLocaleString()}
Total Items: ${sessionItems.length}

SESSION SUMMARY:
- Bug Reports: ${summary.bug || 0}
- Change Requests: ${summary.change || 0} 
- Enhancements: ${summary.enhancement || 0}
- UI Issues: ${summary['ui-issue'] || 0}

DETAILED ITEMS:
`;

            sessionItems.forEach((item, index) => {
                prompt += `
${index + 1}. FEATURE: ${item.featureName}
   TYPE: ${item.issueType}
   DESCRIPTION: ${item.issueDescription}
   ELEMENT: ${item.elementInfo?.tagName || 'N/A'}${item.elementInfo?.id !== 'No ID' ? ' #' + item.elementInfo.id : ''}
   CSS SELECTOR: ${item.elementInfo?.cssSelector || 'N/A'}
   TIMESTAMP: ${item.timestamp}
   
`;
            });

            prompt += `
CONTEXT:
This is a Firebase-based web application with multiple issues/changes identified in a single testing session.

REQUESTED ACTIONS:
1. Analyze all items in priority order (bugs first, then changes, then enhancements)
2. Provide comprehensive solutions for each item
3. Consider interdependencies between changes
4. Maintain Firebase functionality and data flow
5. Provide before/after code snippets for each change

IMPLEMENTATION PRIORITY:
1. Critical bugs (if any)
2. Change requests 
3. UI issues
4. Enhancements

Please provide detailed solutions for each item with code examples.
`;

            return prompt.trim();
        }

        function generateAIPrompt(report) {
            return `
QIGO CARGO APPLICATION - TESTING REPORT FOR AI ASSISTANCE:

Application: Qgo Cargo - Crew & Inventory Management System
Tab/Section: ${report.currentTab}
Feature: ${report.featureName}
Issue Type: ${report.issueType}
Reported On: ${new Date().toLocaleString()}

PROBLEM DESCRIPTION:
${report.issueDescription}

TECHNICAL DETAILS:
${report.elementInfo ? `
- Element: ${report.elementInfo.tagName}
- ID: ${report.elementInfo.id}
- Classes: ${report.elementInfo.className}
- CSS Selector: ${report.elementInfo.cssSelector}
- XPath: ${report.elementInfo.xpath}
` : 'No element captured'}

CONTEXT:
This is a Firebase-based web application using:
- Firebase Firestore for data storage
- Firebase Authentication
- Tailwind CSS for styling
- Chart.js for analytics
- jsPDF for PDF generation

REQUESTED ACTION:
Please analyze this issue and provide a solution to fix the problem described above. 
Consider the Firebase integration and existing code structure when providing the fix.

IMPORTANT: Maintain the existing Firebase functionality and don't break the current data flow.
            `.trim();
        }

        function updateTestReportsList() {
            const reportsList = document.getElementById('test-reports-list');
            const reportCount = document.getElementById('test-report-count');
            
            reportCount.textContent = testingReports.length;
            
            if (testingReports.length === 0) {
                reportsList.innerHTML = '<div style="padding:10px;color:#666;">No test reports saved yet</div>';
                return;
            }

            reportsList.innerHTML = testingReports.map(report => {
                if (report.type === 'multi_capture_session') {
                    return `
                        <div onclick="viewTestReport(${report.id})" style="padding:10px;border-bottom:1px solid #eee;cursor:pointer; background: #f0f8ff;">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <div style="flex: 1;">
                                    <strong>🗂️ SESSION REPORT (${report.totalItems} items)</strong><br>
                                    <small style="color: #666;">${report.timestamp} | Tab: ${report.currentTab}</small><br>
                                    <div style="font-size: 11px; color: #888;">
                                        Bugs: ${report.summary.bugReports} | Changes: ${report.summary.changeRequests} | 
                                        Enhancements: ${report.summary.enhancements} | UI: ${report.summary.uiIssues}
                                    </div>
                                </div>
                                <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">MULTI</span>
                            </div>
                        </div>
                    `;
                } else {
                    const statusColor = report.changeTracking?.implementationStatus === 'completed' ? '#4CAF50' : '#ff9800';
                    return `
                        <div onclick="viewTestReport(${report.id})" style="padding:10px;border-bottom:1px solid #eee;cursor:pointer; position: relative;">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <div style="flex: 1;">
                                    <strong>${report.featureName || 'Single Item'}</strong> - ${report.issueType}<br>
                                    <small style="color: #666;">${report.timestamp}</small>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end;">
                                    <span style="background: ${statusColor}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                        ${report.changeTracking?.implementationStatus || 'PENDING'}
                                    </span>
                                    ${report.elementInfo ? '<span style="font-size: 10px; color: #888;">📍 Element Captured</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function viewTestReport(reportId) {
            const report = testingReports.find(r => r.id === reportId);
            if (!report) return;

            if (report.type === 'multi_capture_session') {
                // Show session report details
                let sessionDetails = `SESSION REPORT DETAILS:\n\n`;
                sessionDetails += `Total Items: ${report.totalItems}\n`;
                sessionDetails += `Session Date: ${report.timestamp}\n`;
                sessionDetails += `Tab: ${report.currentTab}\n\n`;
                sessionDetails += `SUMMARY:\n`;
                sessionDetails += `- Bug Reports: ${report.summary.bugReports}\n`;
                sessionDetails += `- Change Requests: ${report.summary.changeRequests}\n`;
                sessionDetails += `- Enhancements: ${report.summary.enhancements}\n`;
                sessionDetails += `- UI Issues: ${report.summary.uiIssues}\n\n`;
                sessionDetails += `DETAILED ITEMS:\n`;
                
                report.sessionItems.forEach((item, index) => {
                    sessionDetails += `${index + 1}. ${item.featureName} (${item.issueType})\n`;
                    sessionDetails += `   Description: ${item.issueDescription}\n`;
                    if (item.elementInfo) {
                        sessionDetails += `   Element: ${item.elementInfo.tagName}${item.elementInfo.id !== 'No ID' ? '#' + item.elementInfo.id : ''}\n`;
                    }
                    sessionDetails += `\n`;
                });

                sessionDetails += `\n🤖 COMPLETE AI PROMPT COPIED TO CONSOLE!\n`;
                sessionDetails += `Check browser console (F12) to copy the full detailed prompt for AI assistance.`;

                alert(sessionDetails);
                console.log('=== MULTI-CAPTURE SESSION AI PROMPT ===');
                console.log(report.aiPrompt);
                console.log('=== END AI PROMPT ===');
            } else {
                // Show single item report details
                let details = `SINGLE ITEM REPORT:\n\n`;
                details += `Feature: ${report.featureName}\n`;
                details += `Type: ${report.issueType}\n`;
                details += `Description: ${report.issueDescription}\n`;
                details += `Timestamp: ${report.timestamp}\n`;
                details += `Tab: ${report.currentTab}\n\n`;

                if (report.elementInfo) {
                    details += `CAPTURED ELEMENT:\n`;
                    details += `- Tag: ${report.elementInfo.tagName}\n`;
                    details += `- ID: ${report.elementInfo.id}\n`;
                    details += `- Classes: ${report.elementInfo.className}\n`;
                    details += `- Text: ${report.elementInfo.text?.substring(0, 100)}...\n\n`;
                }

                if (report.changeTracking) {
                    details += `CHANGE TRACKING:\n`;
                    details += `- Status: ${report.changeTracking.implementationStatus || 'Pending'}\n`;
                    if (report.changeTracking.expectedChanges) {
                        details += `- Expected Changes: ${report.changeTracking.expectedChanges.length}\n`;
                    }
                    details += `\n`;
                }

                details += `🤖 AI PROMPT COPIED TO CONSOLE!\n`;
                details += `Check browser console (F12) to copy the prompt for AI assistance.`;

                alert(details);
                console.log('=== SINGLE ITEM AI PROMPT ===');
                console.log(report.aiPrompt);
                console.log('=== END AI PROMPT ===');
            }
        }

        function exportTestReports() {
            if (testingReports.length === 0) {
                alert('No test reports to export');
                return;
            }
            const dataStr = JSON.stringify({
                application: 'Qgo Cargo - Crew & Inventory Management',
                exportDate: new Date().toISOString(),
                totalReports: testingReports.length,
                reports: testingReports
            }, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `qgo-cargo-test-reports-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function clearTestReports() {
            if (testingReports.length === 0) return;
            if (confirm('Are you sure you want to clear all test reports?')) {
                testingReports = [];
                localStorage.removeItem('qgoCargoTestReports');
                updateTestReportsList();
            }
        }

        // New functions for multi-capture and change tracking
        function quickAddToSession() {
            // Quick add for continuous capture - no prompts, just capture element info
            if (!sessionId) {
                sessionId = 'SESSION_' + Date.now();
            }

            const sessionItem = {
                id: Date.now(),
                featureName: `Element ${currentSession.length + 1}`, // Auto-generate name
                issueDescription: 'Multi-capture item - details to be added later', // Placeholder
                issueType: 'bug', // Default type
                captured: new Date().toISOString(),
                elementInfo: capturedElement ? {
                    tagName: capturedElement.tagName.toLowerCase(),
                    id: capturedElement.id || 'No ID',
                    className: capturedElement.className || 'No classes',
                    text: capturedElement.textContent?.trim().substring(0, 100) || 'No text',
                    xpath: getElementXPath(capturedElement),
                    cssSelector: getElementCSSSelector(capturedElement),
                    originalValue: getElementValue(capturedElement),
                    screenshot: captureElementScreenshot(capturedElement)
                } : null,
                changeTracking: capturedElement ? {
                    beforeState: captureElementState(capturedElement),
                    implementationStatus: 'pending',
                    expectedChanges: []
                } : null
            };

            currentSession.push(sessionItem);
            updateSessionDisplay();
            
            // Clear element info for next capture
            document.getElementById('element-info').innerHTML = 'Element captured! Click next element...';
        }

        function addToSession() {
            const featureName = document.getElementById('feature-name').value.trim();
            const issueDescription = document.getElementById('issue-description').value.trim();
            const issueType = document.getElementById('issue-type').value;

            if (!featureName || !issueDescription) {
                alert('Please fill in feature name and description before adding to session');
                return;
            }

            if (!sessionId) {
                sessionId = 'SESSION_' + Date.now();
            }

            const sessionItem = {
                id: Date.now(),
                featureName,
                issueDescription,
                issueType,
                elementInfo: capturedElement ? {
                    tagName: capturedElement.tagName.toLowerCase(),
                    id: capturedElement.id || 'No ID',
                    className: capturedElement.className || 'No classes',
                    text: capturedElement.textContent?.trim().substring(0, 100) || 'No text',
                    xpath: getElementXPath(capturedElement),
                    cssSelector: getElementCSSSelector(capturedElement),
                    originalValue: getElementValue(capturedElement),
                    screenshot: captureElementScreenshot(capturedElement)
                } : null,
                timestamp: new Date().toLocaleString(),
                changeTracking: {
                    beforeState: capturedElement ? captureElementState(capturedElement) : null,
                    afterState: null, // Will be filled when change is implemented
                    changeImplemented: false,
                    implementationDate: null
                }
            };

            currentSession.push(sessionItem);
            updateSessionDisplay();
            
            // Clear form for next capture
            document.getElementById('feature-name').value = '';
            document.getElementById('issue-description').value = '';
            document.getElementById('element-info').innerHTML = 'Click "Point & Capture" and then click on any element';
            capturedElement = null;

            alert(`Added to session! Total items: ${currentSession.length}`);
        }

        function clearSession() {
            if (currentSession.length === 0) return;
            if (confirm('Clear current testing session? All unsaved items will be lost.')) {
                currentSession = [];
                sessionId = null;
                updateSessionDisplay();
            }
        }

        function updateSessionDisplay() {
            const sessionDiv = document.getElementById('current-session');
            const sessionCount = document.getElementById('session-count');
            const sessionItems = document.getElementById('session-items');
            const sessionCounter = document.getElementById('session-counter');

            if (currentSession.length === 0) {
                sessionDiv.style.display = 'none';
                sessionCounter.textContent = '';
            } else {
                sessionDiv.style.display = 'block';
                sessionCount.textContent = currentSession.length;
                sessionCounter.textContent = `Session: ${currentSession.length} items captured`;
                
                sessionItems.innerHTML = currentSession.map((item, index) => `
                    <div style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px; background: white;">
                        <div style="display: flex; justify-content: between; align-items: center;">
                            <div style="flex: 1;">
                                <strong>${index + 1}. ${item.featureName}</strong> - ${item.issueType}
                                <div style="font-size: 12px; color: #666;">${item.issueDescription.substring(0, 100)}...</div>
                                ${item.elementInfo ? `<div style="font-size: 11px; color: #888;">Element: ${item.elementInfo.tagName}${item.elementInfo.id !== 'No ID' ? '#' + item.elementInfo.id : ''}</div>` : ''}
                            </div>
                            <button onclick="removeFromSession(${index})" style="background: #ff4444; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">✕</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function showBulkEditDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'bulk-edit-dialog';
            dialog.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10003;
                display: flex; justify-content: center; align-items: center;
            `;

            const dialogContent = document.createElement('div');
            dialogContent.style.cssText = `
                background: white; padding: 20px; border-radius: 10px;
                max-width: 800px; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;

            dialogContent.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #333;">🎯 Bulk Edit Captured Elements (${currentSession.length} items)</h3>
                <p style="color: #666; margin-bottom: 20px;">Now add names and descriptions for your captured elements:</p>
                
                <div id="bulk-edit-items" style="margin-bottom: 20px;">
                    ${currentSession.map((item, index) => `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #2196F3; margin-right: 10px;">Element ${index + 1}:</strong>
                                <code style="background: #e1e1e1; padding: 2px 6px; border-radius: 4px; font-size: 11px;">
                                    ${item.elementInfo?.tagName || 'unknown'}${item.elementInfo?.id !== 'No ID' ? '#' + item.elementInfo?.id : ''}
                                </code>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 3px;">Feature Name:</label>
                                <input type="text" id="bulk-name-${index}" placeholder="Enter feature name..." 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-weight: bold; margin-bottom: 3px;">Issue Type:</label>
                                <select id="bulk-type-${index}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="bug">🐛 Bug</option>
                                    <option value="enhancement">✨ Enhancement</option>
                                    <option value="change-request">🔄 Change Request</option>
                                    <option value="ui-issue">🎨 UI Issue</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 3px;">Description:</label>
                                <textarea id="bulk-desc-${index}" placeholder="Describe the issue or change needed..." 
                                          style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"></textarea>
                            </div>
                            
                            ${item.elementInfo?.text ? `<div style="margin-top: 8px; font-size: 12px; color: #666;"><strong>Element text:</strong> "${item.elementInfo.text}"</div>` : ''}
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button onclick="cancelBulkEdit()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="applyBulkEdit()" style="padding: 10px 20px; border: none; background: #4CAF50; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        ✅ Apply & Save Session
                    </button>
                </div>
            `;

            dialog.appendChild(dialogContent);
            document.body.appendChild(dialog);
        }

        function cancelBulkEdit() {
            const dialog = document.getElementById('bulk-edit-dialog');
            if (dialog) dialog.remove();
        }

        function applyBulkEdit() {
            // Update each session item with the new details
            let allFilled = true;
            
            currentSession.forEach((item, index) => {
                const name = document.getElementById(`bulk-name-${index}`).value.trim();
                const type = document.getElementById(`bulk-type-${index}`).value;
                const desc = document.getElementById(`bulk-desc-${index}`).value.trim();
                
                if (!name || !desc) {
                    allFilled = false;
                    return;
                }
                
                item.featureName = name;
                item.issueType = type;
                item.issueDescription = desc;
            });
            
            if (!allFilled) {
                alert('Please fill in all feature names and descriptions before applying!');
                return;
            }
            
            // Close dialog and update display
            const dialog = document.getElementById('bulk-edit-dialog');
            if (dialog) dialog.remove();
            
            updateSessionDisplay();
            
            alert(`✅ Bulk edit completed!\n${currentSession.length} elements updated.\nClick "Save Session" to create your report.`);
        }

        function removeFromSession(index) {
            currentSession.splice(index, 1);
            updateSessionDisplay();
        }

        function captureElementState(element) {
            return {
                tagName: element.tagName.toLowerCase(),
                id: element.id,
                className: element.className,
                textContent: element.textContent?.trim(),
                innerHTML: element.innerHTML?.substring(0, 500),
                attributes: Array.from(element.attributes).reduce((acc, attr) => {
                    acc[attr.name] = attr.value;
                    return acc;
                }, {}),
                computedStyles: {
                    display: getComputedStyle(element).display,
                    visibility: getComputedStyle(element).visibility,
                    backgroundColor: getComputedStyle(element).backgroundColor,
                    color: getComputedStyle(element).color,
                    fontSize: getComputedStyle(element).fontSize
                },
                value: getElementValue(element),
                position: element.getBoundingClientRect()
            };
        }

        function getElementValue(element) {
            if (!element) return null;
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                return element.value;
            } else if (element.tagName === 'SELECT') {
                return element.selectedOptions[0]?.text || element.value;
            }
            return element.textContent?.trim();
        }

        function captureElementScreenshot(element) {
            // Placeholder for screenshot - in a real implementation, you'd use canvas or library
            const rect = element.getBoundingClientRect();
            return `Screenshot placeholder: Element at ${Math.round(rect.left)}, ${Math.round(rect.top)} (${Math.round(rect.width)}x${Math.round(rect.height)})`;
        }

        function trackChangesInReport(report) {
            // Add change tracking information to reports
            report.changeTracking = {
                detectedChanges: [],
                implementationStatus: 'pending',
                beforeAfterComparison: null,
                codeChanges: [],
                testingNotes: []
            };

            // If this is a change request, add specific change detection
            if (report.issueType === 'change' && report.elementInfo) {
                report.changeTracking.expectedChanges = [
                    {
                        type: 'content_change',
                        element: report.elementInfo.cssSelector,
                        currentValue: report.elementInfo.text,
                        expectedValue: report.issueDescription,
                        priority: 'high'
                    }
                ];
            }

            return report;
        }

        // Missing handler functions for testing mode buttons
        function handleGenerateDummyData() {
            console.log('Generating dummy data...');
            
            try {
                // Generate sample crew data
                const dummyCrews = [
                    { name: 'Ahmed Hassan', role: 'Captain', civilId: 'CID001', email: 'ahmed.hassan@example.com', phone: '+965-12345678', status: 'active' },
                    { name: 'Sarah Mohammed', role: 'Engineer', civilId: 'CID002', email: 'sarah.mohammed@example.com', phone: '+965-87654321', status: 'active' },
                    { name: 'Omar Ali', role: 'Mechanic', civilId: 'CID003', email: 'omar.ali@example.com', phone: '+965-11223344', status: 'inactive' },
                    { name: 'Fatima Abdullah', role: 'Navigator', civilId: 'CID004', email: 'fatima.abdullah@example.com', phone: '+965-44556677', status: 'active' },
                    { name: 'Khalid Yousef', role: 'Cargo Handler', civilId: 'CID005', email: 'khalid.yousef@example.com', phone: '+965-99887766', status: 'active' }
                ];

                // Generate sample inventory data
                const dummyInventory = [
                    { name: 'Container A-001', type: 'Standard Container', location: 'Port-A', status: 'available', weight: 2500 },
                    { name: 'Container B-002', type: 'Refrigerated', location: 'Port-B', status: 'in-use', weight: 3200 },
                    { name: 'Crane Unit-01', type: 'Heavy Machinery', location: 'Yard-1', status: 'maintenance', weight: 15000 },
                    { name: 'Forklift FL-003', type: 'Light Equipment', location: 'Warehouse-C', status: 'available', weight: 800 },
                    { name: 'Cargo Truck CT-005', type: 'Transport Vehicle', location: 'Gate-2', status: 'in-use', weight: 4500 }
                ];

                // Add dummy data to Firebase (if connected) or show in console
                console.log('Generated Dummy Crew Data:', dummyCrews);
                console.log('Generated Dummy Inventory Data:', dummyInventory);
                
                // Show success message
                alert(`✅ Dummy Data Generated Successfully!\n\nCreated:\n• ${dummyCrews.length} crew members\n• ${dummyInventory.length} inventory items\n\nCheck browser console (F12) for details.`);
                
                // You can add Firebase integration here later
                // Example: addDoc(collection(db, 'crews'), crewData);
                
            } catch (error) {
                console.error('Error generating dummy data:', error);
                alert('❌ Error generating dummy data. Check console for details.');
            }
        }

        function handleClearDummyData() {
            console.log('Clearing dummy data...');
            
            if (confirm('⚠️ Are you sure you want to clear all dummy data?\n\nThis action cannot be undone.')) {
                try {
                    // Clear local storage testing data
                    localStorage.removeItem('qgoCargoTestReports');
                    localStorage.removeItem('qgo-testing-reports');
                    
                    console.log('Dummy data cleared from local storage');
                    
                    // Show success message
                    alert('✅ Dummy Data Cleared Successfully!\n\n• Local test reports removed\n• Storage cleaned\n\nNote: Firebase data (if any) would need separate cleanup.');
                    
                    // You can add Firebase cleanup here later
                    // Example: batch delete operations
                    
                } catch (error) {
                    console.error('Error clearing dummy data:', error);
                    alert('❌ Error clearing dummy data. Check console for details.');
                }
            }
        }

        function handleRunSystemCheck() {
            console.log('Running system check...');
            
            try {
                const checks = [];
                
                // Check local storage
                const testReports = localStorage.getItem('qgoCargoTestReports');
                checks.push({
                    name: 'Local Storage',
                    status: testReports ? 'OK' : 'Empty',
                    details: testReports ? `${JSON.parse(testReports).length} reports stored` : 'No test reports found'
                });
                
                // Check testing tool
                const testPanel = document.getElementById('test-panel');
                checks.push({
                    name: 'Testing Tool',
                    status: testPanel ? 'OK' : 'Missing',
                    details: testPanel ? 'Testing panel available' : 'Testing panel not found'
                });
                
                // Check Firebase connection (placeholder)
                checks.push({
                    name: 'Firebase Connection',
                    status: 'Unknown',
                    details: 'Firebase auth and firestore status would be checked here'
                });
                
                // Check essential elements
                const essentialElements = [
                    'generate-dummy-data-btn',
                    'clear-dummy-data-btn', 
                    'floating-test-tool'
                ];
                
                let elementsFound = 0;
                essentialElements.forEach(id => {
                    if (document.getElementById(id)) elementsFound++;
                });
                
                checks.push({
                    name: 'UI Elements',
                    status: elementsFound === essentialElements.length ? 'OK' : 'Issues',
                    details: `${elementsFound}/${essentialElements.length} essential elements found`
                });
                
                // Display results
                const resultsText = checks.map(check => 
                    `${check.name}: ${check.status}\n  ${check.details}`
                ).join('\n\n');
                
                console.log('System Check Results:', checks);
                alert(`🔍 System Check Complete!\n\n${resultsText}\n\nFull details logged to console (F12).`);
                
            } catch (error) {
                console.error('Error during system check:', error);
                alert('❌ Error during system check. Check console for details.');
            }
        }

        function handleGenerateTestReport() {
            console.log('Generating test report...');
            
            try {
                const reports = JSON.parse(localStorage.getItem('qgoCargoTestReports') || '[]');
                const timestamp = new Date().toISOString();
                
                const reportSummary = {
                    generatedAt: timestamp,
                    totalReports: reports.length,
                    reportTypes: {},
                    systemInfo: {
                        userAgent: navigator.userAgent,
                        timestamp: timestamp,
                        url: window.location.href
                    }
                };
                
                // Count report types
                reports.forEach(report => {
                    if (report.type === 'multi_capture_session') {
                        report.sessionItems?.forEach(item => {
                            reportSummary.reportTypes[item.issueType] = (reportSummary.reportTypes[item.issueType] || 0) + 1;
                        });
                    } else {
                        reportSummary.reportTypes[report.issueType] = (reportSummary.reportTypes[report.issueType] || 0) + 1;
                    }
                });
                
                console.log('Test Report Summary:', reportSummary);
                
                const summaryText = `📊 Test Report Generated!\n\nTotal Reports: ${reportSummary.totalReports}\n\nIssue Types:\n${Object.entries(reportSummary.reportTypes).map(([type, count]) => `• ${type}: ${count}`).join('\n')}\n\nGenerated: ${new Date(timestamp).toLocaleString()}\n\nFull details in console (F12).`;
                
                alert(summaryText);
                
            } catch (error) {
                console.error('Error generating test report:', error);
                alert('❌ Error generating test report. Check console for details.');
            }
        }
    </script>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, query, where, getDocs, updateDoc, writeBatch, getDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";
        
        // --- TEMPLATES --- //
        const AnalyticsTemplate = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 sm:gap-6">
                <div class="card flex items-center">
                    <div class="bg-blue-100 p-3 sm:p-4 rounded-full mr-4"><i data-feather="users" class="text-blue-500"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Total Crew</p>
                        <p id="total-users" class="text-xl sm:text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="card flex items-center">
                    <div class="bg-yellow-100 p-3 sm:p-4 rounded-full mr-4"><i data-feather="loader" class="text-yellow-500"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Ongoing Jobs</p>
                        <p id="ongoing-jobs" class="text-xl sm:text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="card flex items-center">
                    <div class="bg-green-100 p-3 sm:p-4 rounded-full mr-4"><i data-feather="check-square" class="text-green-500"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Finished Today</p>
                        <p id="jobs-finished-today" class="text-xl sm:text-2xl font-bold">0</p>
                    </div>
                </div>
                 <div class="card flex items-center">
                    <div class="bg-purple-100 p-3 sm:p-4 rounded-full mr-4"><i data-feather="check-circle" class="text-purple-500"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Finished This Month</p>
                        <p id="jobs-finished-this-month" class="text-xl sm:text-2xl font-bold">0</p>
                    </div>
                </div>
                 <div class="card flex items-center">
                    <div class="bg-red-100 p-3 sm:p-4 rounded-full mr-4"><i data-feather="alert-octagon" class="text-red-500"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Damaged Items</p>
                        <p id="damaged-items-count" class="text-xl sm:text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                <div class="card"><canvas id="inventoryChart"></canvas></div>
                <div class="card"><canvas id="scheduleChart"></canvas></div>
            </div>
            <div class="mt-6">
                <div class="card">
                    <h3 class="font-semibold mb-4">Crew Performance (Jobs This Month)</h3>
                    <canvas id="crewPerformanceChart"></canvas>
                </div>
            </div>
        `;

        const SchedulingTemplate = `
            <div class="card">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold">Crew Schedule</h2>
                    <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto">
                        <input type="date" id="schedule-date" class="border border-gray-300 rounded-md p-2 w-full">
                        <button id="add-schedule-btn" class="btn btn-primary flex-shrink-0"><i data-feather="plus-circle" class="sm:mr-2"></i><span class="hidden sm:inline">New</span></button>
                    </div>
                </div>
                <div id="schedule-container" class="space-y-4">
                    <p class="text-center text-gray-500">Select a date to view or add schedules.</p>
                </div>
            </div>
        `;
        
        const InventoryTemplate = `
            <div class="card">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold">Warehouse Inventory</h2>
                    <button id="add-inventory-btn" class="btn btn-primary w-full sm:w-auto"><i data-feather="plus-circle"></i>Add Item</button>
                </div>
                <input type="text" id="inventory-search" placeholder="Search for items..." class="w-full border border-gray-300 rounded-md p-2 mb-4">
                
                <!-- Mobile View: Card List -->
                <div id="inventory-card-list" class="space-y-4 md:hidden">
                   <!-- Mobile cards will be injected here -->
                </div>

                <!-- Desktop View: Table -->
                <div class="hidden md:block overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="divide-y divide-gray-200">
                           <!-- Desktop rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        const ReportsTemplate = `
            <div class="space-y-8">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Inventory Report</h2>
                    <div class="flex flex-wrap items-center gap-4">
                        <button id="print-inventory-report" class="btn btn-secondary"><i data-feather="printer"></i>Print</button>
                        <button id="pdf-inventory-report" class="btn btn-secondary"><i data-feather="file"></i>Download PDF</button>
                        <button id="excel-inventory-report" class="btn btn-secondary"><i data-feather="grid"></i>Export to Excel</button>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Job Details Report</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4 flex-wrap">
                         <label class="font-medium">From:</label>
                         <input type="date" id="report-start-date" class="border rounded-md p-2">
                         <label class="font-medium">To:</label>
                         <input type="date" id="report-end-date" class="border rounded-md p-2">
                         <button id="generate-job-report" class="btn btn-primary">Generate Report</button>
                    </div>
                    <div id="job-report-actions" class="hidden items-center gap-4 mt-4 flex-wrap">
                        <button id="print-job-report" class="btn btn-secondary"><i data-feather="printer"></i>Print</button>
                        <button id="pdf-job-report" class="btn btn-secondary"><i data-feather="file"></i>Download PDF</button>
                        <button id="excel-job-report" class="btn btn-secondary"><i data-feather="grid"></i>Export to Excel</button>
                    </div>
                    <div id="job-report-container" class="mt-6"></div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Material Usage Report</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4 flex-wrap">
                         <label class="font-medium">Select Material:</label>
                         <select id="material-usage-select" class="w-full sm:w-auto border rounded-md p-2">
                            <option value="">-- Select an Item --</option>
                         </select>
                         <button id="generate-material-report-btn" class="btn btn-primary">Generate Report</button>
                    </div>
                    <div id="material-usage-report-container" class="mt-6"></div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Damaged Items Report</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-4 flex-wrap">
                         <label class="font-medium">From:</label>
                         <input type="date" id="damage-report-start-date" class="border rounded-md p-2">
                         <label class="font-medium">To:</label>
                         <input type="date" id="damage-report-end-date" class="border rounded-md p-2">
                         <button id="generate-damage-report-btn" class="btn btn-primary">Generate Report</button>
                    </div>
                    <div id="damage-report-container" class="mt-6"></div>
                </div>
            </div>
        `;

        const AdminTemplate = `
             <div class="grid grid-cols-1 gap-8">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Pending User Approvals</h2>
                    <div id="pending-users-container" class="space-y-2"></div>
                </div>
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Manage Roles & Permissions</h2>
                        <button id="add-role-btn" class="btn btn-primary"><i data-feather="plus"></i> New Role</button>
                    </div>
                    <div id="roles-list-container" class="space-y-2"></div>
                    <h3 class="text-lg font-semibold mt-6 mb-2 pt-4 border-t">Assign Roles to Registered Users</h3>
                    <div id="approved-users-roles-container" class="space-y-2"></div>
                </div>
                <div class="card">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Manage All Crew Profiles</h2>
                        <button id="add-crew-btn" class="btn btn-primary"><i data-feather="user-plus"></i> Add Manually</button>
                    </div>
                     <div id="user-list-container" class="space-y-3"></div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Send Notifications</h2>
                    <form id="send-notification-form" class="space-y-4">
                        <input type="text" id="notification-title" class="w-full border rounded-md p-2" placeholder="Notification Title" required>
                        <textarea id="notification-message" class="w-full border rounded-md p-2 h-24" placeholder="Notification Message" required></textarea>
                        <button type="submit" class="btn btn-primary">Send Notification</button>
                    </form>
                </div>
            </div>
        `;

        const MaintenanceTemplate = `
            <div class="card">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold">Vehicle Maintenance Logs</h2>
                    <button id="add-vehicle-btn" class="btn btn-primary w-full sm:w-auto"><i data-feather="plus-circle"></i> Add Vehicle</button>
                </div>
                <div id="vehicle-list-container" class="space-y-4">
                    <!-- Vehicle details will be injected here -->
                </div>
            </div>
        `;

        const NotificationsTemplate = `
            <div class="card">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold">Notifications & Alerts</h2>
                    <div class="flex gap-2">
                        <button id="refresh-notifications-btn" class="btn btn-secondary"><i data-feather="refresh-ccw"></i></button>
                        <button id="clear-notifications-btn" class="btn btn-danger"><i data-feather="trash-2"></i></button>
                    </div>
                </div>
                <div id="notifications-list" class="space-y-4">
                    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded-md">
                        <div class="flex items-center">
                            <i data-feather="info" class="text-blue-400 mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-blue-800">Welcome to Qgo Cargo!</p>
                                <p class="text-sm text-blue-700">Your warehouse management system is ready.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const TestingTemplate = `
            <div class="space-y-8">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Data Management</h2>
                    <div class="flex flex-wrap gap-4">
                         <button id="generate-dummy-data-btn" class="btn btn-primary"><i data-feather="plus-circle" class="mr-2"></i>Generate Dummy Data</button>
                         <button id="clear-dummy-data-btn" class="btn btn-danger"><i data-feather="trash-2" class="mr-2"></i>Clear Dummy Data</button>
                    </div>
                     <p class="text-sm text-gray-500 mt-4">Generate sample crew, inventory, and schedules to test system functionality. Clear the data when you are finished.</p>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">System Check</h2>
                     <button id="run-system-check-btn" class="btn btn-secondary mb-4"><i data-feather="play-circle" class="mr-2"></i>Run System Check</button>
                     <div id="system-check-results" class="space-y-2"></div>
                </div>

                <div class="card">
                     <h2 class="text-xl font-semibold mb-4">Feedback & Bug Report</h2>
                     <div class="space-y-4">
                        <div>
                            <label for="feedback-notes" class="block text-sm font-medium text-gray-700 mb-1">Testing Notes & Comments</label>
                            <textarea id="feedback-notes" class="w-full border rounded-md p-2 h-32" placeholder="Describe any issues or suggestions here..."></textarea>
                        </div>
                        <button id="generate-test-report-btn" class="btn btn-primary"><i data-feather="download" class="mr-2"></i>Generate Report</button>
                     </div>
                </div>
            </div>
        `;


        // --- FIREBASE CONFIG & INITIALIZATION --- //
        let db, auth, userId, app, dataPath, currentUserIsAdmin, messaging;
        let usersUnsubscribe, inventoryUnsubscribe, schedulesUnsubscribe, rolesUnsubscribe, pendingUsersUnsubscribe, vehiclesUnsubscribe;
        let inventoryChartInstance, scheduleChartInstance, crewPerformanceChartInstance;
        
        // --- IMPORTANT FIREBASE CONFIGURATION --- //
        const firebaseConfig = {
            apiKey: "AIzaSyD6tMBDcZSR32ZwWIwc_ff2zHp26tSesMw",
            authDomain: "qgowhm.firebaseapp.com",
            projectId: "qgowhm",
            storageBucket: "qgowhm.appspot.com", // FIX: Corrected to standard format
            messagingSenderId: "331703931357",
            appId: "1:331703931357:web:b25ed7f60db706b1072634",
            measurementId: "G-5VXETKM4H8"
        };
        // --- END OF CONFIGURATION --- //

        async function handleSendNotification(e) {
            e.preventDefault();
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;
            if (title && message) {
                try {
                    // Store notification in Firestore
                    await addDoc(collection(db, `${dataPath}/notifications`), {
                        title: title,
                        message: message,
                        timestamp: serverTimestamp(),
                        sentBy: auth.currentUser.uid,
                        type: 'admin_broadcast'
                    });
                    
                    showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Notification sent successfully!</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                    feather.replace();
                    
                    document.getElementById('notification-title').value = '';
                    document.getElementById('notification-message').value = '';
                } catch (error) {
                    console.error('Error sending notification:', error);
                    showModal(`<div class="p-4 text-center"><p class="text-lg font-medium text-red-600">Error sending notification. Please try again.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                    feather.replace();
                }
            }
        }

        // Initialize Firebase Cloud Messaging
        async function initFCM() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                }
            } catch (error) {
                console.error('FCM initialization error:', error);
            }
            
            // Handle foreground messages (when app is open)
            onMessage(messaging, (payload) => {
                console.log('Message received:', payload);
                new Notification(payload.notification.title, {
                    body: payload.notification.body,
                    icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 192 192"%3E%3Crect width="192" height="192" fill="%233182ce" rx="24"/%3E%3Cpath d="M48 64h96v8H48v-8zm0 24h96v8H48v-8zm0 24h64v8H48v-8z" fill="white"/%3E%3Ccircle cx="80" cy="120" r="16" fill="white"/%3E%3Ccircle cx="112" cy="120" r="16" fill="white"/%3E%3Crect x="72" y="136" width="48" height="8" fill="white" rx="4"/%3E%3C/svg%3E'
                });
            });
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                messaging = getMessaging(app);
                
                initFCM();
                
                onAuthStateChanged(auth, async (user) => {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const authContainer = document.getElementById('auth-container');
                    const appContainer = document.getElementById('app-container');
                    const pendingCard = document.getElementById('pending-approval-card');
                    const loginCard = document.getElementById('login-card');
                    const registerCard = document.getElementById('register-card');
                    
                    if (user) {
                        const regRef = doc(db, 'registrations', user.uid);
                        const regDoc = await getDoc(regRef);

                        if (regDoc.exists()) { // User is in the registration system
                            const regData = regDoc.data();
                            if (regData.status === 'approved') {
                                if (!regData.adminUID) {
                                    console.error("Approved user is missing adminUID in registrations document:", user.uid);
                                    document.getElementById('login-error').textContent = 'Account configuration error. Please contact admin.';
                                    await signOut(auth);
                                } else {
                                    // This is an approved, regular user.
                                    userId = regData.adminUID;
                                    dataPath = `users/${userId}`;
                                    currentUserIsAdmin = false;
                                    document.getElementById('user-info').textContent = user.email;
                                    document.getElementById('testing-tab-link').classList.add('hidden');
                                    authContainer.classList.add('hidden');
                                    appContainer.classList.remove('hidden');
                                    attachDataListeners();
                                    switchTab('analytics');
                                }
                            } else { // 'pending' or other status
                                // This is a pending user. Show the message and sign out.
                                loginCard.classList.add('hidden');
                                registerCard.classList.add('hidden');
                                pendingCard.classList.remove('hidden');
                                feather.replace();
                                await signOut(auth); // This will re-trigger onAuthStateChanged with user=null
                            }
                        } else {
                            // User is NOT in the registration system. Assume they are an admin or a new admin.
                            const userRootRef = doc(db, `users/${user.uid}`);
                            const userRootDoc = await getDoc(userRootRef);
                            if(!userRootDoc.exists()){
                                await setDoc(userRootRef, { isAdmin: true, createdAt: serverTimestamp() });
                            }
                            // Proceed as admin
                            userId = user.uid;
                            dataPath = `users/${userId}`;
                            currentUserIsAdmin = true;
                            
                            document.getElementById('user-info').textContent = user.email + ' (Admin)';
                             document.getElementById('testing-tab-link').classList.remove('hidden');
                            authContainer.classList.add('hidden');
                            appContainer.classList.remove('hidden');
                            attachDataListeners();
                            attachPendingUsersListener();
                            switchTab('analytics');
                        }
                    } else {
                        // No user logged in
                        userId = null;
                        dataPath = null;
                        currentUserIsAdmin = false;
                        authContainer.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                        loginCard.classList.remove('hidden');
                        registerCard.classList.add('hidden');
                        pendingCard.classList.add('hidden');
                        document.getElementById('testing-tab-link').classList.add('hidden');


                        if (usersUnsubscribe) usersUnsubscribe();
                        if (inventoryUnsubscribe) inventoryUnsubscribe();
                        if (schedulesUnsubscribe) schedulesUnsubscribe();
                        if (rolesUnsubscribe) rolesUnsubscribe();
                        if (pendingUsersUnsubscribe) pendingUsersUnsubscribe();
                    }
                    loadingOverlay.style.display = 'none';
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500">Error setting up Firebase connection. Check your config object.</p>`;
            }
        }
        
        // --- DATA LISTENERS --- //
        function attachDataListeners() {
            if (!dataPath) return;
            attachUsersListener();
            attachInventoryListener();
            attachRolesListener();
            attachVehiclesListener();
            attachNotificationsListener();
            const scheduleDate = document.getElementById('schedule-date').value || new Date().toISOString().split('T')[0];
            attachScheduleListener(scheduleDate);
        }

        function attachVehiclesListener() {
            const vehiclesCollectionPath = `${dataPath}/vehicles`;
            if (vehiclesUnsubscribe) vehiclesUnsubscribe();
            vehiclesUnsubscribe = onSnapshot(collection(db, vehiclesCollectionPath), (snapshot) => {
                window.appState.vehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderVehicles();
            }, (error) => console.error("Error with vehicles snapshot listener:", error));
        }

        function attachNotificationsListener() {
            const notificationsCollectionPath = `${dataPath}/notifications`;
            if (window.notificationsUnsubscribe) window.notificationsUnsubscribe();
            window.notificationsUnsubscribe = onSnapshot(
                query(collection(db, notificationsCollectionPath), orderBy('timestamp', 'desc')),
                (snapshot) => {
                    const newNotifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Update notifications display in UI
                    renderNotifications(newNotifications);
                }, 
                (error) => console.error("Error with notifications snapshot listener:", error)
            );
        }

        function renderNotifications(notifications) {
            const notificationsList = document.getElementById('notifications-list');
            if (!notificationsList) return;
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-gray-500 text-center py-4">No notifications yet</p>';
                return;
            }
            
            notificationsList.innerHTML = notifications.map(notification => {
                const date = notification.timestamp?.toDate?.() || new Date();
                const timeString = date.toLocaleString();
                
                return `
                    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded-md mb-2">
                        <div class="flex items-start">
                            <i data-feather="bell" class="text-blue-400 mr-3 mt-1 flex-shrink-0"></i>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-blue-800">${notification.title}</p>
                                <p class="text-sm text-blue-700 mt-1">${notification.message}</p>
                                <p class="text-xs text-blue-600 mt-2">${timeString}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            feather.replace();
        }

        function attachPendingUsersListener() {
            if (!currentUserIsAdmin) return;
            const pendingQuery = query(collection(db, 'registrations'), where('status', '==', 'pending'));
            if (pendingUsersUnsubscribe) pendingUsersUnsubscribe();
            pendingUsersUnsubscribe = onSnapshot(pendingQuery, (snapshot) => {
                 window.appState.pendingUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderPendingUsers();
            }, (error) => console.error("Error with pending users snapshot:", error));
        }

        function attachUsersListener() {
            const usersCollectionPath = `${dataPath}/crew`;
            if (usersUnsubscribe) usersUnsubscribe();
            usersUnsubscribe = onSnapshot(collection(db, usersCollectionPath), (snapshot) => {
                window.appState.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUsersAdmin();
                renderApprovedUsersForRoles();
                updateDashboardCards();
            }, (error) => console.error("Error with crew snapshot listener:", error));
        }
        
        function attachRolesListener() {
            const rolesCollectionPath = `${dataPath}/roles`;
            if (rolesUnsubscribe) rolesUnsubscribe();
            rolesUnsubscribe = onSnapshot(collection(db, rolesCollectionPath), (snapshot) => {
                window.appState.roles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRolesAdmin();
                renderApprovedUsersForRoles();
            }, (error) => console.error("Error with roles snapshot listener:", error));
        }

        function attachInventoryListener() {
             const inventoryCollectionPath = `${dataPath}/inventory`;
             if(inventoryUnsubscribe) inventoryUnsubscribe();
             inventoryUnsubscribe = onSnapshot(collection(db, inventoryCollectionPath), (snapshot) => {
                window.appState.inventory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), quantity: Number(doc.data().quantity) }));
                renderInventory();
                updateDashboardCards();
                updateInventoryChart();
            }, (error) => console.error("Error with inventory snapshot listener:", error));
        }
        
        function attachScheduleListener(date) {
            if (!dataPath) return;
            const schedulesCollectionPath = `${dataPath}/schedules`;
            if (schedulesUnsubscribe) schedulesUnsubscribe();
            const q = query(collection(db, schedulesCollectionPath), where("date", "==", date));
            schedulesUnsubscribe = onSnapshot(q, (snapshot) => {
                window.appState.schedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSchedules(date);
                updateDashboardCards();
                updateScheduleChart();
            }, (error) => console.error(`Error with schedules snapshot listener for date ${date}:`, error));
        }

        // --- UI RENDERING --- //
        function renderPendingUsers() {
            const container = document.getElementById('pending-users-container');
            if(!container) return;
            container.innerHTML = (window.appState.pendingUsers || []).map(user => `
                <div class="flex justify-between items-center p-3 border rounded-md bg-yellow-50">
                    <div>
                        <p class="font-medium text-yellow-800">${user.name || user.email}</p>
                        <p class="text-sm text-yellow-600">Civil ID: ${user.civilId || user.email || 'Not provided'}</p>
                    </div>
                    <button class="approve-user-btn btn btn-success" data-id="${user.id}" data-email="${user.email}">Approve</button>
                </div>
            `).join('') || '<p class="text-center text-gray-500 py-4">No pending approvals.</p>';
            
            document.querySelectorAll('.approve-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    showApproveUserModal(e.currentTarget.dataset.id, e.currentTarget.dataset.email);
                });
            });
        }
        
        function renderUsersAdmin() {
            const userListContainer = document.getElementById('user-list-container');
            if (!userListContainer) return;
            userListContainer.innerHTML = (window.appState.users || []).map(user => {
                const role = window.appState.roles.find(r => r.id === user.roleId);
                let detailsHtml = `<div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">`;
                if(user.mobileNumber) detailsHtml += `<div class="text-gray-500">Mobile:</div><div class="font-medium text-gray-800">${user.mobileNumber}</div>`;
                if(user.civilId) detailsHtml += `<div class="text-gray-500">Civil ID:</div><div class="font-medium text-gray-800">${user.civilId}</div>`;
                if(user.truckType) detailsHtml += `<div class="text-gray-500">Truck Type:</div><div class="font-medium text-gray-800">${user.truckType}</div>`;
                if(user.truckNumber) detailsHtml += `<div class="text-gray-500">Truck #:</div><div class="font-medium text-gray-800">${user.truckNumber}</div>`;
                detailsHtml += `</div>`;
                
                return `
                <details class="bg-gray-50 rounded-lg border">
                    <summary class="flex justify-between items-center p-3 cursor-pointer">
                        <div>
                            <p class="font-semibold text-gray-900">${user.name}</p>
                            <p class="text-sm text-gray-600">${role?.name || 'No Role'}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <button class="edit-user-btn text-blue-500 hover:text-blue-700 p-2" data-id="${user.id}"><i data-feather="edit-2"></i></button>
                             <button class="delete-user-btn text-red-500 hover:text-red-700 p-2" data-id="${user.id}"><i data-feather="trash-2"></i></button>
                        </div>
                    </summary>
                    <div class="p-3 border-t bg-white">
                        ${detailsHtml}
                    </div>
                </details>
            `}).join('') || '<p class="text-center text-gray-500 py-4">No crew members created yet.</p>';
            feather.replace();
            document.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idToDelete = e.currentTarget.dataset.id;
                    showConfirmationModal('Are you sure you want to delete this crew member?', async () => {
                        await deleteUser(idToDelete);
                    });
                });
            });
            document.querySelectorAll('.edit-user-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idToEdit = e.currentTarget.dataset.id;
                    const user = window.appState.users.find(u => u.id === idToEdit);
                    showUserModal(user);
                });
            });
        }
        
        function renderRolesAdmin() {
            const rolesContainer = document.getElementById('roles-list-container');
            if(!rolesContainer) return;
            rolesContainer.innerHTML = (window.appState.roles || []).map(role => `
                 <div class="flex justify-between items-center p-3 border rounded-md">
                     <p class="font-semibold">${role.name}</p>
                     <div class="flex items-center gap-2">
                         <button class="edit-role-btn text-blue-500 hover:text-blue-700 p-2" data-id="${role.id}"><i data-feather="edit-2"></i></button>
                         <button class="delete-role-btn text-red-500 hover:text-red-700 p-2" data-id="${role.id}"><i data-feather="trash-2"></i></button>
                     </div>
                 </div>
            `).join('') || '<p class="text-center text-gray-500 py-4">No roles created yet.</p>';
            feather.replace();
             document.querySelectorAll('.edit-role-btn').forEach(btn => btn.addEventListener('click', e => {
                const role = window.appState.roles.find(r => r.id === e.currentTarget.dataset.id);
                showRoleModal(role);
            }));
             document.querySelectorAll('.delete-role-btn').forEach(btn => btn.addEventListener('click', e => {
                 showConfirmationModal('Are you sure you want to delete this role?', () => deleteRole(e.currentTarget.dataset.id));
            }));
        }

        function renderApprovedUsersForRoles() {
            const container = document.getElementById('approved-users-roles-container');
            if (!container) return;
            
            const approvedUsers = window.appState.users.filter(u => u.authUID);
            
            container.innerHTML = approvedUsers.map(user => {
                const role = window.appState.roles.find(r => r.id === user.roleId);
                return `
                    <div class="flex justify-between items-center p-3 border rounded-md hover:bg-gray-50">
                        <div>
                            <p class="font-medium">${user.name} (Civil ID: ${user.civilId || user.email || 'N/A'})</p>
                            <p class="text-sm text-gray-500">Current Role: <span class="font-semibold">${role?.name || 'Unassigned'}</span></p>
                        </div>
                        <button class="edit-user-role-btn btn btn-secondary !p-2" data-id="${user.id}"><i data-feather="edit-2"></i> Change Role</button>
                    </div>
                `;
            }).join('') || '<p class="text-center text-gray-500 py-4">No registered users have been approved yet.</p>';

            feather.replace();

            document.querySelectorAll('.edit-user-role-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToEdit = e.currentTarget.dataset.id;
                    const user = window.appState.users.find(u => u.id === idToEdit);
                    showUserModal(user);
                });
            });
        }
        
        function renderInventory() {
            const tableBody = document.getElementById('inventory-table-body');
            const cardList = document.getElementById('inventory-card-list');
            if (!tableBody || !cardList) return;

            const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
            const inventory = window.appState.inventory || [];
            const filteredInventory = inventory.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                (item.sku && item.sku.toLowerCase().includes(searchTerm))
            );
            
            if (filteredInventory.length === 0) {
                const emptyMessage = `<tr><td colspan="5" class="text-center py-8 text-gray-500">No inventory items found.</td></tr>`;
                tableBody.innerHTML = emptyMessage;
                cardList.innerHTML = `<p class="text-center py-8 text-gray-500">No inventory items found.</p>`;
                return;
            }
            
            const placeholderImg = 'https://placehold.co/60x60/e2e8f0/adb5bd?text=No+Image';

            tableBody.innerHTML = filteredInventory.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="py-4 px-6"><img src="${item.imageData || placeholderImg}" alt="${item.name}" class="w-12 h-12 rounded-md object-cover"></td>
                    <td class="py-4 px-6 font-medium">${item.name}</td>
                    <td class="py-4 px-6 text-gray-600">${item.sku || 'N/A'}</td>
                    <td class="py-4 px-6 font-semibold">${item.quantity}</td>
                    <td class="py-4 px-6">
                        <button class="edit-inventory-btn text-blue-500 hover:text-blue-700 p-2" data-id="${item.id}"><i data-feather="edit"></i></button>
                        <button class="delete-inventory-btn text-red-500 hover:text-red-700 p-2" data-id="${item.id}"><i data-feather="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
            
            cardList.innerHTML = filteredInventory.map(item => `
                <div class="border rounded-lg p-4 bg-white shadow-sm">
                    <div class="flex items-start gap-4">
                        <img src="${item.imageData || placeholderImg}" alt="${item.name}" class="w-16 h-16 rounded-md object-cover flex-shrink-0">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">SKU: ${item.sku || 'N/A'}</p>
                            <p class="text-sm text-gray-500">Quantity: <span class="font-semibold">${item.quantity}</span></p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end gap-2">
                        <button class="edit-inventory-btn btn btn-secondary !p-2" data-id="${item.id}"><i data-feather="edit"></i></button>
                        <button class="delete-inventory-btn btn btn-danger !p-2" data-id="${item.id}"><i data-feather="trash-2"></i></button>
                    </div>
                </div>
            `).join('');

            feather.replace();
            document.querySelectorAll('.edit-inventory-btn').forEach(btn => btn.addEventListener('click', handleEditInventory));
            document.querySelectorAll('.delete-inventory-btn').forEach(btn => btn.addEventListener('click', handleDeleteInventory));
        }

        function renderSchedules(date) {
            const container = document.getElementById('schedule-container');
            if (!container) return;
            const schedules = window.appState.schedules || [];
            const users = window.appState.users || [];
            
            if(schedules.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500 py-8">No schedules found for ${date}.</p>`;
                 return;
            }
            
            container.innerHTML = schedules.map(schedule => {
                const assignedUsers = schedule.assignedUserIds.map(id => users.find(u => u.id === id)).filter(Boolean);
                const crewLeader = assignedUsers.find(u => u.role === 'Crew Leader');
                const priorityColors = {'High': 'bg-red-100 text-red-800', 'Medium': 'bg-yellow-100 text-yellow-800', 'Low': 'bg-blue-100 text-blue-800'};
                const statusColors = {'Finished': 'bg-green-100 text-green-800', 'Pending': 'bg-yellow-100 text-yellow-800', 'Pending Confirmation': 'bg-orange-100 text-orange-800'};
                const isSupervisor = currentUserIsAdmin;

                let materialStatusHTML = '';
                if (schedule.status === 'Pending Confirmation') {
                    materialStatusHTML = `<span class="text-xs font-semibold text-yellow-600 flex items-center gap-1"><i data-feather="clock" class="w-3 h-3"></i> Returns Pending Confirmation</span>`;
                } else if (schedule.materialsConfirmed) {
                     materialStatusHTML = `<span class="text-xs font-semibold text-green-600 flex items-center gap-1"><i data-feather="check-circle" class="w-3 h-3"></i> Returns Confirmed</span>`;
                }
                
                let materialsUsedText = '';
                if (Array.isArray(schedule.materialsUsed)) {
                    materialsUsedText = schedule.materialsUsed.map(m => `${m.quantity} - ${m.itemName}`).join('<br>');
                } else if (typeof schedule.materialsUsed === 'string' && schedule.materialsUsed) {
                    materialsUsedText = schedule.materialsUsed.replace(/\n/g, '<br>');
                }

                const renderReconciliationDetails = () => {
                    if (!schedule.reconciliationDetails) return '';
                    let detailsHtml = '<p><strong>Reconciliation Details:</strong></p><ul class="list-disc pl-5 text-gray-600">';
                    for (const [key, value] of Object.entries(schedule.reconciliationDetails.returnedItems)) {
                        const item = window.appState.inventory.find(i => i.id === key);
                        detailsHtml += `<li>${item?.name || 'Unknown Item'}: ${value}</li>`;
                    }
                    detailsHtml += '</ul>';
                    if (schedule.reconciliationDetails.discrepancyNotes) {
                         detailsHtml += `<p class="mt-2"><strong>Discrepancy Notes:</strong><br><span class="text-gray-600 whitespace-pre-wrap">${schedule.reconciliationDetails.discrepancyNotes}</span></p>`;
                    }
                    return detailsHtml;
                };

                return `
                    <div class="border rounded-lg p-4 bg-white shadow-sm">
                        <div class="flex justify-between items-start">
                           <div class="flex-1 overflow-hidden">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <h3 class="font-bold text-base sm:text-lg text-blue-600 truncate">${schedule.task}</h3>
                                    <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${statusColors[schedule.status] || 'bg-gray-100'} flex-shrink-0">${schedule.status}</span>
                                    ${schedule.priority ? `<span class="text-xs font-semibold px-2.5 py-1 rounded-full ${priorityColors[schedule.priority]} flex-shrink-0">${schedule.priority}</span>` : ''}
                                </div>
                                <p class="text-sm text-gray-500 flex items-center"><i data-feather="clock" class="w-4 h-4 mr-2 flex-shrink-0"></i>${schedule.startTime} - ${schedule.endTime}</p>
                                ${schedule.address ? `<p class="text-sm text-gray-500 mt-1 flex items-center"><i data-feather="map-pin" class="w-4 h-4 mr-2 flex-shrink-0"></i>${schedule.address}</p>` : ''}
                                ${schedule.vehicle ? `<p class="text-sm text-gray-500 mt-1 flex items-center"><i data-feather="truck" class="w-4 h-4 mr-2 flex-shrink-0"></i>${schedule.vehicle}</p>` : ''}
                                ${schedule.status !== 'Pending' && schedule.completionTime ? `<p class="text-sm text-gray-600 mt-1 flex items-center font-semibold"><i data-feather="check-circle" class="w-4 h-4 mr-2 flex-shrink-0"></i>Submitted at ${new Date(schedule.completionTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>` : ''}
                                
                                <p class="mt-3 text-sm text-gray-700">${schedule.notes || 'No notes.'}</p>
                                
                                ${(schedule.materialsUsed && ( (Array.isArray(schedule.materialsUsed) && schedule.materialsUsed.length > 0) || typeof schedule.materialsUsed === 'string' )) ? `
                                <details class="mt-4 text-sm">
                                    <summary class="font-semibold cursor-pointer flex justify-between items-center">
                                        <span>Material Details</span>
                                        ${materialStatusHTML}
                                    </summary>
                                    <div class="pl-4 mt-2 border-l-2 space-y-2">
                                        ${materialsUsedText ? `<p><strong>Used:</strong><br><span class="text-gray-600 whitespace-pre-wrap">${materialsUsedText}</span></p>` : ''}
                                        ${renderReconciliationDetails()}
                                        ${schedule.materialReturnPhotoData ? `<p><strong>Confirmation Photo:</strong><br><img src="${schedule.materialReturnPhotoData}" class="w-24 h-24 rounded-md object-cover mt-1 border"></p>` : ''}
                                        ${schedule.materialsConfirmedBy ? `<p class="mt-2 text-xs text-gray-500">Confirmed by ${schedule.materialsConfirmedBy} at ${new Date(schedule.materialsConfirmationTime).toLocaleString()}</p>` : ''}
                                    </div>
                                </details>
                                ` : ''}

                                <div class="mt-4">
                                    ${crewLeader ? `<p class="font-semibold text-sm mb-2">Leader: <span class="font-normal bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded-full">${crewLeader.name}</span></p>` : ''}
                                    <p class="font-semibold text-sm">Crew:</p>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        ${assignedUsers.map(user => `<span class="bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${user.name}</span>`).join('')}
                                    </div>
                                </div>
                           </div>
                           <div class="flex flex-col items-end gap-2 ml-2">
                                <button class="share-whatsapp-btn btn btn-primary !bg-green-500 hover:!bg-green-600 !p-2" data-id="${schedule.id}"><i data-feather="share-2"></i></button>
                                <button class="edit-schedule-btn btn btn-secondary !p-2" data-id="${schedule.id}"><i data-feather="edit"></i></button>
                                <button class="delete-schedule-btn btn btn-danger !p-2" data-id="${schedule.id}"><i data-feather="trash-2"></i></button>
                           </div>
                        </div>
                        <div class="mt-4 pt-4 border-t flex flex-col sm:flex-row gap-2">
                            ${schedule.status === 'Pending' ? `<button class="complete-schedule-btn btn btn-success w-full" data-id="${schedule.id}"><i data-feather="check-circle"></i>Mark as Complete</button>` : ''}
                            ${(isSupervisor && schedule.status === 'Pending Confirmation') ? `<button class="confirm-return-btn btn btn-primary !bg-indigo-500 hover:!bg-indigo-600 w-full" data-id="${schedule.id}"><i data-feather="shield"></i>Confirm Material Returns</button>`: ''}
                        </div>
                    </div>
                `;
            }).join('');
            feather.replace();
            document.querySelectorAll('.share-whatsapp-btn, .edit-schedule-btn, .delete-schedule-btn, .complete-schedule-btn, .confirm-return-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    if (btn.classList.contains('share-whatsapp-btn')) handleShareToWhatsApp(id);
                    if (btn.classList.contains('edit-schedule-btn')) handleEditSchedule(id);
                    if (btn.classList.contains('delete-schedule-btn')) handleDeleteSchedule(id);
                    if (btn.classList.contains('complete-schedule-btn')) handleCompleteSchedule(id);
                    if (btn.classList.contains('confirm-return-btn')) showConfirmReturnModal(id);
                });
            });
        }

        // --- DASHBOARD & CHARTS --- //
        async function updateDashboardCards() {
            try {
                const totalUsersEl = document.getElementById('total-users');
                if (totalUsersEl) totalUsersEl.textContent = window.appState.users.length;
                
                const allSchedulesQuery = query(collection(db, `${dataPath}/schedules`));
                const allSchedulesSnapshot = await getDocs(allSchedulesQuery);
                const allSchedules = allSchedulesSnapshot.docs.map(doc => doc.data());

                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                
                const ongoingJobs = allSchedules.filter(s => s.status === 'Pending' || s.status === 'Pending Confirmation').length;
                document.getElementById('ongoing-jobs').textContent = ongoingJobs;
                
                const jobsFinishedToday = allSchedules.filter(s => s.status === 'Finished' && s.date === todayStr).length;
                document.getElementById('jobs-finished-today').textContent = jobsFinishedToday;
                
                const jobsFinishedThisMonth = allSchedules.filter(s => s.status === 'Finished' && s.date >= startOfMonth).length;
                document.getElementById('jobs-finished-this-month').textContent = jobsFinishedThisMonth;

                const damagedItemsQuery = query(collection(db, `${dataPath}/damagedItems`));
                const damagedItemsSnapshot = await getDocs(damagedItemsQuery);
                document.getElementById('damaged-items-count').textContent = damagedItemsSnapshot.size;

            } catch (e) {
                console.error("Error updating dashboard cards:", e);
            }
        }
        
        function initCharts() {
            try {
                if (inventoryChartInstance) inventoryChartInstance.destroy();
                if (scheduleChartInstance) scheduleChartInstance.destroy();
                if (crewPerformanceChartInstance) crewPerformanceChartInstance.destroy();
                
                const inventoryCanvas = document.getElementById('inventoryChart');
                if(inventoryCanvas) {
                    const inventoryCtx = inventoryCanvas.getContext('2d');
                    inventoryChartInstance = new Chart(inventoryCtx, {
                        type: 'doughnut',
                        data: { labels: [], datasets: [{ data: [] }] },
                        options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Inventory by Quantity' } } }
                    });
                }

                const scheduleCanvas = document.getElementById('scheduleChart');
                if (scheduleCanvas) {
                     const scheduleCtx = scheduleCanvas.getContext('2d');
                     scheduleChartInstance = new Chart(scheduleCtx, {
                        type: 'bar',
                        data: { labels: [], datasets: [{ label: 'Tasks', data: [] }] },
                        options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Tasks by Status (Today)' } }, scales: { y: { beginAtZero: true } } }
                    });
                }

                const crewPerformanceCanvas = document.getElementById('crewPerformanceChart');
                if (crewPerformanceCanvas) {
                    const crewCtx = crewPerformanceCanvas.getContext('2d');
                    crewPerformanceChartInstance = new Chart(crewCtx, {
                        type: 'bar',
                        data: { labels: [], datasets: [{ label: 'Jobs Completed This Month', data: [], backgroundColor: '#8b5cf6' }] },
                        options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Crew Performance' } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                }

                updateInventoryChart();
                updateScheduleChart();
                updateCrewPerformanceChart();
            } catch (e) {
                console.error("Error initializing charts:", e);
            }
        }
        
        function updateInventoryChart() {
            if (!inventoryChartInstance) return;
            try {
                const inventory = window.appState.inventory || [];
                const top5Items = inventory.sort((a, b) => b.quantity - a.quantity).slice(0, 5);
                inventoryChartInstance.data.labels = top5Items.map(item => item.name);
                inventoryChartInstance.data.datasets[0].data = top5Items.map(item => item.quantity);
                inventoryChartInstance.data.datasets[0].backgroundColor = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1'];
                inventoryChartInstance.update();
            } catch(e) {
                console.error("Error updating inventory chart:", e);
            }
        }
        
        function updateScheduleChart() {
            if (!scheduleChartInstance) return;
            try {
                const schedules = window.appState.schedules || [];
                const statusCounts = schedules.reduce((acc, schedule) => {
                    acc[schedule.status] = (acc[schedule.status] || 0) + 1;
                    return acc;
                }, {});
                scheduleChartInstance.data.labels = Object.keys(statusCounts);
                scheduleChartInstance.data.datasets[0].data = Object.values(statusCounts);
                scheduleChartInstance.data.datasets[0].backgroundColor = ['#f59e0b', '#10b981', '#f97316'];
                scheduleChartInstance.update();
            } catch(e) {
                console.error("Error updating schedule chart:", e);
            }
        }

        async function updateCrewPerformanceChart() {
            if (!crewPerformanceChartInstance) return;
            try {
                const users = window.appState.users || [];
                const userJobCounts = new Map(users.map(u => [u.id, 0]));

                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);

                // FIX: Query only by date range, then filter by status in code to avoid needing a composite index.
                const monthQuery = query(
                    collection(db, `${dataPath}/schedules`),
                    where("completionTime", ">=", startOfMonth.toISOString())
                );
                const querySnapshot = await getDocs(monthQuery);

                querySnapshot.forEach(doc => {
                    const schedule = doc.data();
                    // FIX: Filter for finished status here
                    if (schedule.status === 'Finished') {
                        schedule.assignedUserIds.forEach(userId => {
                            if (userJobCounts.has(userId)) {
                                userJobCounts.set(userId, userJobCounts.get(userId) + 1);
                            }
                        });
                    }
                });

                const sortedUsers = [...userJobCounts.entries()].sort((a, b) => b[1] - a[1]);
                
                crewPerformanceChartInstance.data.labels = sortedUsers.map(([userId, count]) => {
                    const user = users.find(u => u.id === userId);
                    return user ? user.name : 'Unknown';
                });
                crewPerformanceChartInstance.data.datasets[0].data = sortedUsers.map(([userId, count]) => count);
                crewPerformanceChartInstance.update();

            } catch(e) {
                console.error("Error updating crew performance chart:", e);
            }
        }
        
        // Testing functions are now in global scope above
        
        // --- DATA MANIPULATION --- //
        async function addUser(userData) { try { await addDoc(collection(db, `${dataPath}/crew`), userData); } catch(e) { console.error("Firestore Error: Could not add crew member.", e); } }
        async function updateUser(id, userData) { try { await setDoc(doc(db, `${dataPath}/crew/${id}`), userData, { merge: true }); } catch(e) { console.error("Firestore Error: Could not update crew member.", e); } }
        async function deleteUser(id) { try { await deleteDoc(doc(db, `${dataPath}/crew/${id}`)); } catch(e) { console.error("Firestore Error: Could not delete crew member.", e); } }
        async function addRole(roleData) { try { await addDoc(collection(db, `${dataPath}/roles`), roleData); } catch(e) { console.error("Firestore Error: Could not add role.", e); } }
        async function updateRole(id, roleData) { try { await setDoc(doc(db, `${dataPath}/roles/${id}`), roleData); } catch(e) { console.error("Firestore Error: Could not update role.", e); } }
        async function deleteRole(id) { try { await deleteDoc(doc(db, `${dataPath}/roles/${id}`)); } catch(e) { console.error("Firestore Error: Could not delete role.", e); } }
        async function addInventory(item) { try { await addDoc(collection(db, `${dataPath}/inventory`), item); } catch(e) { console.error("Firestore Error: Could not add inventory.", e); } }
        async function updateInventory(id, item) { try { await setDoc(doc(db, `${dataPath}/inventory/${id}`), item); } catch(e) { console.error("Firestore Error: Could not update inventory.", e); } }
        async function deleteInventory(id) { try { await deleteDoc(doc(db, `${dataPath}/inventory/${id}`)); } catch(e) { console.error("Firestore Error: Could not delete inventory.", e); } }
        async function addSchedule(schedule) { try { await addDoc(collection(db, `${dataPath}/schedules`), schedule); } catch(e) { console.error("Firestore Error: Could not add schedule.", e); } }
        async function updateSchedule(id, schedule) { try { await setDoc(doc(db, `${dataPath}/schedules/${id}`), schedule, { merge: true }); } catch(e) { console.error("Firestore Error: Could not update schedule.", e); } }
        async function addVehicle(vehicleData) { try { await addDoc(collection(db, `${dataPath}/vehicles`), vehicleData); } catch(e) { console.error("Firestore Error: Could not add vehicle.", e); } }
        async function updateVehicle(id, vehicleData) { try { await setDoc(doc(db, `${dataPath}/vehicles/${id}`), vehicleData); } catch(e) { console.error("Firestore Error: Could not update vehicle.", e); } }
        async function deleteVehicle(id) { try { await deleteDoc(doc(db, `${dataPath}/vehicles/${id}`)); } catch(e) { console.error("Firestore Error: Could not delete vehicle.", e); } }
        async function addMaintenanceLog(vehicleId, logData) { try { await addDoc(collection(db, `${dataPath}/vehicles/${vehicleId}/maintenanceLogs`), logData); } catch(e) { console.error("Firestore Error: Could not add maintenance log.", e); } }
        async function deleteMaintenanceLog(vehicleId, logId) { try { await deleteDoc(doc(db, `${dataPath}/vehicles/${vehicleId}/maintenanceLogs/${logId}`)); } catch(e) { console.error("Firestore Error: Could not delete maintenance log.", e); } }
        
        async function deleteSchedule(id) {
            const schedule = window.appState.schedules.find(s => s.id === id);
            if (!schedule) return;
            
            try {
                const batch = writeBatch(db);

                // Return materials to inventory if they haven't been confirmed as returned yet
                if (Array.isArray(schedule.materialsUsed) && schedule.materialsUsed.length > 0 && !schedule.materialsConfirmed) {
                    for (const material of schedule.materialsUsed) {
                        const itemRef = doc(db, `${dataPath}/inventory/${material.itemId}`);
                        const itemDoc = await getDoc(itemRef);
                        if (itemDoc.exists()) {
                            const currentQty = Number(itemDoc.data().quantity);
                            batch.update(itemRef, { quantity: currentQty + material.quantity });
                        }
                    }
                }

                // Delete the schedule
                const scheduleRef = doc(db, `${dataPath}/schedules/${id}`);
                batch.delete(scheduleRef);

                await batch.commit();
            } catch (e) {
                console.error("Firestore Error: Could not delete schedule and update inventory.", e);
            }
        }

        async function updateScheduleStatus(id, scheduleData) {
            try {
                const scheduleRef = doc(db, `${dataPath}/schedules/${id}`);
                let newStatus = 'Finished';

                if (Array.isArray(scheduleData.materialsUsed) && scheduleData.materialsUsed.length > 0) {
                    newStatus = 'Pending Confirmation';
                }

                const updateData = { 
                    status: newStatus,
                    completionTime: new Date().toISOString()
                };
                await updateDoc(scheduleRef, updateData);
            } catch(e) {
                console.error("Firestore Error: Could not update schedule status.", e);
            }
        }
        
        async function confirmMaterialReturns(id, reconciliationData) {
            try {
                const batch = writeBatch(db);
                // 1. Update Inventory with good items
                for (const [itemId, returnedQtyStr] of Object.entries(reconciliationData.returnedItems)) {
                    const returnedQty = Number(returnedQtyStr);
                    if(isNaN(returnedQty) || returnedQty < 0) continue;

                    const itemRef = doc(db, `${dataPath}/inventory/${itemId}`);
                    const itemDoc = await getDoc(itemRef);
                    if(itemDoc.exists()){
                        const currentQty = Number(itemDoc.data().quantity);
                        batch.update(itemRef, { quantity: currentQty + returnedQty });
                    }
                }
                
                // 2. Log Damaged Items
                for (const [itemId, damagedQtyStr] of Object.entries(reconciliationData.damagedItems)) {
                    const damagedQty = Number(damagedQtyStr);
                    if (isNaN(damagedQty) || damagedQty <= 0) continue;
                    
                    const item = window.appState.inventory.find(i => i.id === itemId);
                    const damageLogRef = doc(collection(db, `${dataPath}/damagedItems`));
                    batch.set(damageLogRef, {
                        itemId: itemId,
                        itemName: item?.name || 'Unknown Item',
                        quantity: damagedQty,
                        scheduleId: id,
                        date: new Date().toISOString().split('T')[0],
                        timestamp: serverTimestamp()
                    });
                }


                // 3. Update Schedule
                const scheduleRef = doc(db, `${dataPath}/schedules/${id}`);
                batch.update(scheduleRef, {
                    status: 'Finished',
                    materialsConfirmed: true,
                    materialsConfirmedBy: window.appState.impersonatedUser?.name || 'Admin',
                    materialsConfirmationTime: new Date().toISOString(),
                    materialReturnPhotoData: reconciliationData.photoData,
                    reconciliationDetails: {
                        returnedItems: reconciliationData.returnedItems,
                        damagedItems: reconciliationData.damagedItems,
                        discrepancyNotes: reconciliationData.discrepancyNotes,
                    }
                });

                await batch.commit();

            } catch(e) {
                console.error("Firestore Error: Could not confirm material returns.", e);
            }
        }
        
        // --- EVENT HANDLERS & MODALS --- //
        
        function showModal(content) {
            const modalContent = document.getElementById('modal-content');
            const modal = document.getElementById('form-modal');
            modalContent.innerHTML = content;
            modal.classList.remove('hidden'); modal.classList.add('flex');
            setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
        }
        
        function hideModal() {
            const modalContent = document.getElementById('modal-content');
            const modal = document.getElementById('form-modal');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 200);
        }

        function showConfirmationModal(message, onConfirm) {
            const modalHTML = `
                <div class="p-4 text-center">
                    <p class="text-lg font-medium mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                        <button id="confirm-ok" class="btn btn-danger">Confirm</button>
                    </div>
                </div>
            `;
            showModal(modalHTML);
            document.getElementById('confirm-ok').addEventListener('click', () => {
                onConfirm();
                hideModal();
            }, { once: true });
             document.getElementById('confirm-cancel').addEventListener('click', hideModal, { once: true });
        }
        
        function setupModalEventListeners() {
            document.getElementById('form-modal').addEventListener('click', (e) => {
                if (e.target.id === 'form-modal' || e.target.closest('.close-modal-btn')) {
                    hideModal();
                }
            });
        }
        
        function handleImageUpload(event, previewElementId, hiddenInputId) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400;
                    const MAX_HEIGHT = 400;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                    
                    document.getElementById(previewElementId).src = dataUrl;
                    document.getElementById(hiddenInputId).value = dataUrl;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showUserModal(userToEdit = null) {
            const modalTitle = userToEdit ? 'Edit Crew Member' : 'Create New Crew Member';
            const roleOptions = window.appState.roles.map(r => `<option value="${r.id}" ${userToEdit?.roleId === r.id ? 'selected' : ''}>${r.name}</option>`).join('');
            const isRegisteredUser = userToEdit?.authUID;

            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">${modalTitle}</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="user-modal-form" class="space-y-4">
                    <input type="hidden" name="id" value="${userToEdit?.id || ''}">
                    <input type="hidden" name="authUID" value="${userToEdit?.authUID || ''}">
                    
                    <fieldset class="border rounded-md p-3">
                        <legend class="text-sm font-medium text-gray-700 px-1">Basic Info</legend>
                        <div class="space-y-4 pt-2">
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                <input type="text" name="name" required class="w-full border border-gray-300 rounded-md p-2" value="${userToEdit?.name || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Civil ID</label>
                                <input type="text" name="civilId" required class="w-full border border-gray-300 rounded-md p-2 ${isRegisteredUser ? 'bg-gray-100' : ''}" value="${userToEdit?.civilId || ''}" ${isRegisteredUser ? 'readonly' : ''} placeholder="Enter Civil ID number">
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">4-Digit PIN</label>
                                <input type="number" name="pin" pattern="\\d{4}" title="PIN must be 4 digits" class="w-full border border-gray-300 rounded-md p-2" value="${userToEdit?.pin || ''}" placeholder="e.g., 1234">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Role (Category)</label>
                                <select name="roleId" required class="w-full border border-gray-300 rounded-md p-2">
                                    <option value="">Select a role</option>
                                    ${roleOptions}
                                </select>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="border rounded-md p-3">
                        <legend class="text-sm font-medium text-gray-700 px-1">Additional Details</legend>
                        <div class="space-y-4 pt-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                                <input type="tel" name="mobileNumber" class="w-full border rounded-md p-2" value="${userToEdit?.mobileNumber || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Civil ID Number</label>
                                <input type="text" name="civilId" class="w-full border rounded-md p-2" value="${userToEdit?.civilId || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Truck Type</label>
                                <input type="text" name="truckType" class="w-full border rounded-md p-2" value="${userToEdit?.truckType || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Truck Number</label>
                                <input type="text" name="truckNumber" class="w-full border rounded-md p-2" value="${userToEdit?.truckNumber || ''}">
                            </div>
                        </div>
                    </fieldset>
                    <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary">Save Member</button>
                    </div>
                </form>
            `;
            showModal(modalHTML);
            feather.replace();

            document.getElementById('user-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const id = formData.get('id');
                const userData = Object.fromEntries(formData.entries());
                delete userData.id;

                if (id) {
                    await updateUser(id, userData);
                } else {
                    await addUser(userData);
                }
                hideModal();
            });
        }
        
        function showScheduleModal(scheduleToEdit = null) {
            const users = window.appState.users || [];
            const date = document.getElementById('schedule-date').value;
            if (!date && !scheduleToEdit) {
                showModal(`<div class="p-4"><p class="text-center text-red-600 font-medium">Please select a date first.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                return;
            }
            const assignedIds = scheduleToEdit?.assignedUserIds || [];
            const userCheckboxes = users.map(u => `
                <div class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100">
                    <input type="checkbox" id="user-check-${u.id}" name="assignedUserIds" value="${u.id}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${assignedIds.includes(u.id) ? 'checked' : ''}>
                    <label for="user-check-${u.id}" class="flex-1 text-sm font-medium text-gray-700">${u.name}</label>
                </div>
            `).join('');

            const modalTitle = scheduleToEdit ? `Edit Schedule` : `New Schedule for ${date}`;
            
            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">${modalTitle}</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="schedule-modal-form" class="space-y-4">
                    <input type="hidden" name="id" value="${scheduleToEdit?.id || ''}">
                    <input type="hidden" name="date" value="${scheduleToEdit?.date || date}">
                     <div><label class="block text-sm font-medium mb-1">Task / Job Site</label>
                         <input type="text" name="task" required class="w-full border rounded-md p-2" value="${scheduleToEdit?.task || ''}"></div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div><label class="block text-sm font-medium mb-1">Job Site Address</label>
                            <input type="text" name="address" class="w-full border rounded-md p-2" value="${scheduleToEdit?.address || ''}"></div>
                         <div><label class="block text-sm font-medium mb-1">Vehicle/Equipment</label>
                            <input type="text" name="vehicle" class="w-full border rounded-md p-2" value="${scheduleToEdit?.vehicle || ''}"></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium mb-1">Start Time</label>
                            <input type="time" name="startTime" required class="w-full border rounded-md p-2" value="${scheduleToEdit?.startTime || ''}"></div>
                        <div><label class="block text-sm font-medium mb-1">End Time</label>
                            <input type="time" name="endTime" required class="w-full border rounded-md p-2" value="${scheduleToEdit?.endTime || ''}"></div>
                    </div>
                     <div><label class="block text-sm font-medium mb-1">Priority</label>
                         <select name="priority" class="w-full border rounded-md p-2">
                             <option value="Low" ${scheduleToEdit?.priority === 'Low' ? 'selected' : ''}>Low</option>
                             <option value="Medium" ${scheduleToEdit?.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                             <option value="High" ${scheduleToEdit?.priority === 'High' ? 'selected' : ''}>High</option>
                         </select></div>
                    <div><label class="block text-sm font-medium mb-1">Assign Crew</label>
                        <div class="border rounded-md p-2 h-40 overflow-y-auto space-y-1">${userCheckboxes}</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Materials to be Used</label>
                        <div id="materials-list-container" class="space-y-2 border rounded-md p-2"></div>
                        <button type="button" id="add-material-row-btn" class="btn btn-secondary !p-2 mt-2"><i data-feather="plus"></i> Add Material</button>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium">Notes</label>
                            <button type="button" id="generate-notes-btn" class="text-xs text-blue-600 hover:underline font-semibold">✨ Generate with AI</button>
                        </div>
                        <textarea name="notes" id="schedule-notes" class="w-full border rounded-md p-2 h-24">${scheduleToEdit?.notes || ''}</textarea>
                    </div>
                    <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary">Save Schedule</button>
                    </div>
                </form>`;
            showModal(modalHTML);
            feather.replace();
            
            document.getElementById('generate-notes-btn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const task = document.querySelector('#schedule-modal-form [name="task"]').value;
                const address = document.querySelector('#schedule-modal-form [name="address"]').value;
                if(!task) {
                    showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Please enter a task before generating notes.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                    feather.replace();
                    return;
                }

                let materialsText = 'Materials: ';
                document.querySelectorAll('.material-row').forEach(row => {
                    const itemName = row.querySelector('.material-item-search').value;
                    const quantity = row.querySelector('.material-item-quantity').value;
                    if (itemName && quantity) {
                        materialsText += `${quantity}x ${itemName}, `;
                    }
                });

                const prompt = `
                    Generate brief, actionable notes for a cargo or logistics crew about to perform a task. 
                    The notes should be formatted with clear headings like "Instructions:", "Safety Reminders:", and "Checklist:".
                    Be concise and practical.
                    Task: "${task}"
                    Location: "${address}"
                    ${materialsText.length > 12 ? materialsText : ''}
                `;
                
                btn.textContent = 'Generating...';
                btn.disabled = true;
                try {
                    const notes = await callGeminiAPI(prompt);
                    document.getElementById('schedule-notes').value = notes;
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Could not generate notes. Please try again.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                    feather.replace();
                } finally {
                    btn.textContent = '✨ Generate with AI';
                    btn.disabled = false;
                }
            });

            const addMaterialRow = (material = { itemId: '', quantity: '' }) => {
                const container = document.getElementById('materials-list-container');
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 material-row relative';

                row.innerHTML = `
                    <input type="text" class="material-item-search w-1/2 border rounded-md p-2" placeholder="Search for item..." value="${material.itemName || ''}">
                    <input type="hidden" class="material-item-id" value="${material.itemId || ''}">
                    <div class="material-search-results absolute top-full left-0 w-1/2 bg-white border shadow-lg max-h-40 overflow-y-auto z-10 hidden"></div>
                    <input type="number" class="material-item-quantity w-1/4 border rounded-md p-2" placeholder="Qty" min="1" value="${material.quantity}">
                    <button type="button" class="remove-material-row-btn btn btn-danger !p-2"><i data-feather="trash-2"></i></button>
                `;
                container.appendChild(row);
                feather.replace();

                const searchInput = row.querySelector('.material-item-search');
                const resultsContainer = row.querySelector('.material-search-results');
                const idInput = row.querySelector('.material-item-id');
                const qtyInput = row.querySelector('.material-item-quantity');

                searchInput.addEventListener('keyup', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    if (!searchTerm) {
                        resultsContainer.classList.add('hidden');
                        return;
                    }
                    const filteredItems = window.appState.inventory.filter(item => item.name.toLowerCase().includes(searchTerm));
                    resultsContainer.innerHTML = filteredItems.map(item => 
                        `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-id="${item.id}" data-name="${item.name}" data-stock="${item.quantity}">
                            ${item.name} (In Stock: ${item.quantity})
                         </div>`
                    ).join('');
                    resultsContainer.classList.remove('hidden');
                });

                resultsContainer.addEventListener('click', (e) => {
                    if(e.target.classList.contains('p-2')) {
                        idInput.value = e.target.dataset.id;
                        searchInput.value = e.target.dataset.name;
                        qtyInput.max = e.target.dataset.stock;
                        resultsContainer.classList.add('hidden');
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if (!row.contains(e.target)) {
                        resultsContainer.classList.add('hidden');
                    }
                }, true);

                row.querySelector('.remove-material-row-btn').addEventListener('click', () => row.remove());
            };

            document.getElementById('add-material-row-btn').addEventListener('click', () => addMaterialRow());

            if (scheduleToEdit && Array.isArray(scheduleToEdit.materialsUsed)) {
                scheduleToEdit.materialsUsed.forEach(addMaterialRow);
            }

            document.getElementById('schedule-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const id = formData.get('id');
                
                const materialsUsed = [];
                let hasError = false;
                document.querySelectorAll('.material-row').forEach(row => {
                    const itemId = row.querySelector('.material-item-id').value;
                    const itemName = row.querySelector('.material-item-search').value;
                    const quantity = Number(row.querySelector('.material-item-quantity').value);

                    if (itemId && quantity > 0) {
                         const stock = Number(row.querySelector('.material-item-quantity').max || '0');
                         const oldQty = (scheduleToEdit?.materialsUsed?.find(m => m.itemId === itemId)?.quantity || 0);
                         if (quantity > stock + oldQty) {
                            showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Not enough stock for ${itemName}. Only ${stock + oldQty} available.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                            feather.replace();
                            hasError = true;
                         }
                        materialsUsed.push({ itemId, itemName, quantity });
                    }
                });
                if(hasError) return;

                const batch = writeBatch(db);
                
                // --- Inventory Update Logic ---
                const oldMaterials = (Array.isArray(scheduleToEdit?.materialsUsed) ? scheduleToEdit.materialsUsed : []) || [];
                const inventoryChanges = new Map();

                oldMaterials.forEach(m => inventoryChanges.set(m.itemId, (inventoryChanges.get(m.itemId) || 0) + m.quantity));
                materialsUsed.forEach(m => inventoryChanges.set(m.itemId, (inventoryChanges.get(m.itemId) || 0) - m.quantity));
                
                for(const [itemId, change] of inventoryChanges.entries()){
                    if (change !== 0) {
                        const itemRef = doc(db, `${dataPath}/inventory/${itemId}`);
                        const currentItem = window.appState.inventory.find(i => i.id === itemId);
                        // FIX: Correctly add back to inventory or subtract from it.
                        batch.update(itemRef, { quantity: currentItem.quantity + change });
                    }
                }
                // --- End Inventory Logic ---
                
                const schedule = {
                    date: formData.get('date'), task: formData.get('task'), startTime: formData.get('startTime'),
                    endTime: formData.get('endTime'), notes: formData.get('notes'), assignedUserIds: formData.getAll('assignedUserIds'),
                    address: formData.get('address'), vehicle: formData.get('vehicle'), priority: formData.get('priority'),
                    status: scheduleToEdit?.status || 'Pending',
                    materialsUsed: materialsUsed,
                    materialsConfirmed: scheduleToEdit?.materialsConfirmed || false,
                };

                if (id) { 
                    const scheduleRef = doc(db, `${dataPath}/schedules/${id}`);
                    batch.set(scheduleRef, schedule, { merge: true });
                } else { 
                    const newScheduleRef = doc(collection(db, `${dataPath}/schedules`));
                    batch.set(newScheduleRef, schedule);
                }

                await batch.commit();
                hideModal();
            });
        }
        
        function showConfirmReturnModal(id) {
            const schedule = window.appState.schedules.find(s => s.id === id);
            if (!schedule || !schedule.materialsUsed || schedule.materialsUsed.length === 0) return;
            
            const reconciliationFields = schedule.materialsUsed.map((item, index) => `
                <div class="grid grid-cols-1 gap-2 border-t pt-3 mt-3">
                     <p class="font-medium text-gray-800">${item.itemName} (Used: ${item.quantity})</p>
                     <div class="grid grid-cols-2 gap-2">
                         <div>
                            <label for="recon-good-${index}" class="text-sm font-medium text-gray-700">Good Qty</label>
                            <input type="number" id="recon-good-${index}" data-item-id="${item.itemId}" data-item-name="${item.itemName}" name="good-${item.itemId}" class="w-full border rounded-md p-2 good-qty-input" placeholder="Good" max="${item.quantity}" min="0" value="${item.quantity}">
                         </div>
                         <div>
                            <label for="recon-damaged-${index}" class="text-sm font-medium text-gray-700">Damaged Qty</label>
                            <input type="number" id="recon-damaged-${index}" name="damaged-${item.itemId}" class="w-full border rounded-md p-2 damaged-qty-input" placeholder="Damaged" max="${item.quantity}" min="0" value="0">
                        </div>
                    </div>
                </div>
            `).join('');

            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Reconcile Material Returns</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="confirm-return-form" class="space-y-4">
                    <input type="hidden" name="id" value="${id}">
                    <div class="space-y-3 p-3 border rounded-md bg-gray-50">
                        <h3 class="font-semibold mb-2">Returned & Damaged Quantities</h3>
                        ${reconciliationFields}
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Photo of Returned Items</label>
                        <input type="file" id="confirm-photo-input" accept="image/*" capture="environment" class="hidden">
                        <input type="hidden" id="photo-data-input" name="photoData">
                        <button type="button" id="add-confirm-photo-btn" class="btn btn-secondary w-full mt-1"><i data-feather="camera"></i>Add Photo</button>
                        <img id="photo-preview" src="" class="mt-2 w-24 h-24 rounded-md object-cover border hidden">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Discrepancy Notes (Required if quantities don't match)</label>
                        <textarea name="discrepancyNotes" class="w-full border rounded-md p-2 h-24" placeholder="e.g., 'One drill was damaged on site.'"></textarea>
                    </div>
                    <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary !bg-indigo-500">Confirm & Finish Job</button>
                    </div>
                </form>
            `;
            showModal(modalHTML);
            feather.replace();

            document.getElementById('add-confirm-photo-btn').addEventListener('click', () => document.getElementById('confirm-photo-input').click());
            document.getElementById('confirm-photo-input').addEventListener('change', (e) => {
                document.getElementById('photo-preview').classList.remove('hidden');
                handleImageUpload(e, 'photo-preview', 'photo-data-input');
            });

            document.getElementById('confirm-return-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const scheduleId = formData.get('id');
                
                const returnedItems = {};
                const damagedItems = {};

                document.querySelectorAll('.good-qty-input').forEach(input => {
                    if (input.value) returnedItems[input.dataset.itemId] = input.value;
                });
                document.querySelectorAll('.damaged-qty-input').forEach(input => {
                     if (input.value) damagedItems[input.dataset.itemId] = input.value;
                });

                const reconciliationData = {
                    photoData: formData.get('photoData'),
                    discrepancyNotes: formData.get('discrepancyNotes'),
                    returnedItems: returnedItems,
                    damagedItems: damagedItems
                };
                
                await confirmMaterialReturns(scheduleId, reconciliationData);
                hideModal();
            });
        }
        
        function showRoleModal(roleToEdit = null) {
            const modalTitle = roleToEdit ? 'Edit Role' : 'Create New Role';
            const perms = roleToEdit?.permissions || {};
            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">${modalTitle}</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="role-modal-form" class="space-y-4">
                    <input type="hidden" name="id" value="${roleToEdit?.id || ''}">
                    <div>
                        <label class="block text-sm font-medium mb-1">Role Name</label>
                        <input type="text" name="name" required class="w-full border rounded-md p-2" value="${roleToEdit?.name || ''}">
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-2">Permissions</h3>
                        <div class="space-y-2">
                           <label class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100"><input type="checkbox" name="canManageInventory" class="h-5 w-5 rounded" ${perms.canManageInventory ? 'checked' : ''}> Can Manage Inventory</label>
                           <label class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100"><input type="checkbox" name="canManageSchedules" class="h-5 w-5 rounded" ${perms.canManageSchedules ? 'checked' : ''}> Can Manage Schedules</label>
                           <label class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100"><input type="checkbox" name="canConfirmReturns" class="h-5 w-5 rounded" ${perms.canConfirmReturns ? 'checked' : ''}> Can Confirm Returns</label>
                           <label class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100"><input type="checkbox" name="canManageCrew" class="h-5 w-5 rounded" ${perms.canManageCrew ? 'checked' : ''}> Can Manage Crew</label>
                           <label class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100"><input type="checkbox" name="canViewAnalytics" class="h-5 w-5 rounded" ${perms.canViewAnalytics ? 'checked' : ''}> Can View Analytics</label>
                        </div>
                    </div>
                     <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary">Save Role</button>
                    </div>
                </form>
            `;
            showModal(modalHTML);
            feather.replace();
             document.getElementById('role-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const id = formData.get('id');
                const roleData = {
                    name: formData.get('name'),
                    permissions: {
                        canManageInventory: formData.has('canManageInventory'),
                        canManageSchedules: formData.has('canManageSchedules'),
                        canConfirmReturns: formData.has('canConfirmReturns'),
                        canManageCrew: formData.has('canManageCrew'),
                        canViewAnalytics: formData.has('canViewAnalytics'),
                    }
                };
                if(id) { await updateRole(id, roleData); } 
                else { await addRole(roleData); }
                hideModal();
            });
        }

        function showApproveUserModal(pendingUserId, userEmail) {
            if (!window.appState.roles || window.appState.roles.length === 0) {
                const noRolesHTML = `
                    <div class="text-center p-4">
                         <i data-feather="alert-circle" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold mb-4">No Roles Found</h2>
                        <p class="text-gray-600 mb-6">You must create at least one role before you can approve a user. Please go to the 'Manage Roles & Permissions' section to create a new role.</p>
                        <button type="button" class="close-modal-btn btn btn-primary">OK</button>
                    </div>
                `;
                showModal(noRolesHTML);
                feather.replace();
                return;
            }

            const roleOptions = window.appState.roles.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Approve User</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="approve-user-form">
                    <p class="mb-4">Assign a role to <strong>${userEmail}</strong> to approve their account.</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assign Role</label>
                        <select name="roleId" required class="w-full border rounded-md p-2">
                            <option value="">Select a role</option>
                            ${roleOptions}
                        </select>
                    </div>
                     <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-success">Approve</button>
                    </div>
                </form>
            `;
            showModal(modalHTML);
            feather.replace();
            document.getElementById('approve-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const roleId = e.target.roleId.value;
                if(!roleId) {
                    showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Please select a role.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                    feather.replace();
                    return;
                }
                const batch = writeBatch(db);
                // 1. Update registration doc
                const regRef = doc(db, 'registrations', pendingUserId);
                batch.update(regRef, { status: 'approved', adminUID: userId, roleId: roleId });

                // 2. Create a basic crew member profile for them
                const crewRef = doc(collection(db, `${dataPath}/crew`));
                batch.set(crewRef, { name: userEmail.split('@')[0], email: userEmail, roleId: roleId, authUID: pendingUserId });

                await batch.commit();
                hideModal();
            });
        }
        
        function handleEditSchedule(id) {
            const schedule = window.appState.schedules.find(s => s.id === id);
            if(schedule) { showScheduleModal(schedule); }
        }

        async function handleCompleteSchedule(id) {
            const schedule = window.appState.schedules.find(s => s.id === id);
            if(schedule) {
                 await updateScheduleStatus(id, schedule);
            }
        }
        
        function handleAddInventory() {
            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Add Inventory Item</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="inventory-modal-form" class="space-y-4">
                     <div><label class="block text-sm font-medium mb-1">Item Name</label><input type="text" name="name" required class="w-full border rounded-md p-2"></div>
                     <div><label class="block text-sm font-medium mb-1">SKU</label><input type="text" name="sku" class="w-full border rounded-md p-2"></div>
                     <div><label class="block text-sm font-medium mb-1">Quantity</label><input type="number" name="quantity" required class="w-full border rounded-md p-2" min="0"></div>
                     <div>
                        <label class="block text-sm font-medium mb-1">Item Photo</label>
                        <input type="file" id="inventory-photo-input" accept="image/*" capture="environment" class="hidden">
                        <input type="hidden" id="inventory-photo-data" name="imageData">
                        <button type="button" id="add-inventory-photo-btn" class="btn btn-secondary w-full mt-1"><i data-feather="camera"></i>Add Photo</button>
                        <img id="inventory-photo-preview" src="" class="mt-2 w-24 h-24 rounded-md object-cover border hidden">
                     </div>
                     <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary">Add Item</button>
                    </div>
                </form>
            `;
            showModal(modalHTML);
            feather.replace();

            document.getElementById('add-inventory-photo-btn').addEventListener('click', () => document.getElementById('inventory-photo-input').click());
            document.getElementById('inventory-photo-input').addEventListener('change', (e) => {
                document.getElementById('inventory-photo-preview').classList.remove('hidden');
                handleImageUpload(e, 'inventory-photo-preview', 'inventory-photo-data');
            });

            document.getElementById('inventory-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const item = Object.fromEntries(formData.entries());
                item.quantity = Number(item.quantity);
                await addInventory(item);
                hideModal();
            });
        }
        
        function handleEditInventory(e) {
             const id = e.currentTarget.dataset.id;
             const item = window.appState.inventory.find(i => i.id === id);
             if (!item) return;
             const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Edit Inventory Item</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="inventory-modal-form" class="space-y-4">
                     <input type="hidden" name="id" value="${item.id}">
                     <div><label class="block text-sm font-medium mb-1">Item Name</label><input type="text" name="name" required class="w-full border rounded-md p-2" value="${item.name}"></div>
                     <div><label class="block text-sm font-medium mb-1">SKU</label><input type="text" name="sku" class="w-full border rounded-md p-2" value="${item.sku || ''}"></div>
                     <div><label class="block text-sm font-medium mb-1">Quantity</label><input type="number" name="quantity" required class="w-full border rounded-md p-2" value="${item.quantity}" min="0"></div>
                     <div>
                        <label class="block text-sm font-medium mb-1">Item Photo</label>
                        <input type="file" id="inventory-photo-input" accept="image/*" capture="environment" class="hidden">
                        <input type="hidden" id="inventory-photo-data" name="imageData" value="${item.imageData || ''}">
                        <button type="button" id="add-inventory-photo-btn" class="btn btn-secondary w-full mt-1"><i data-feather="camera"></i>Add Photo</button>
                        <img id="inventory-photo-preview" src="${item.imageData || ''}" class="mt-2 w-24 h-24 rounded-md object-cover border ${item.imageData ? '' : 'hidden'}">
                     </div>
                     <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            `;
             showModal(modalHTML);
             feather.replace();

             document.getElementById('add-inventory-photo-btn').addEventListener('click', () => document.getElementById('inventory-photo-input').click());
             document.getElementById('inventory-photo-input').addEventListener('change', (e) => {
                 document.getElementById('inventory-photo-preview').classList.remove('hidden');
                 handleImageUpload(e, 'inventory-photo-preview', 'inventory-photo-data');
             });

             document.getElementById('inventory-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const id = formData.get('id');
                const updatedItem = Object.fromEntries(formData.entries());
                delete updatedItem.id;
                updatedItem.quantity = Number(updatedItem.quantity);
                await updateInventory(id, updatedItem);
                hideModal();
            });
        }
        function handleDeleteInventory(e) { const id = e.currentTarget.dataset.id; showConfirmationModal('Delete inventory item?', async () => { await deleteInventory(id);});}
        function handleDeleteSchedule(id) { showConfirmationModal('Delete this schedule?', async () => { await deleteSchedule(id); }); }
        
        async function handleShareToWhatsApp(id) {
            const schedule = window.appState.schedules.find(s => s.id === id);
            if(!schedule) return;
            const users = window.appState.users;
            const assignedUsersList = schedule.assignedUserIds.map(id => users.find(u => u.id === id)).filter(Boolean);
            const crewLeader = assignedUsersList.find(u => u.role === 'Crew Leader');
            const assignedUsersText = assignedUsersList.map(u => `  - ${u.name}`).join('\n');
            let message = `*🗓️ Crew Schedule: ${schedule.date}*\n\n` +
                          `*Status:* ${schedule.status}\n` +
                          `*Task:* ${schedule.task}\n` +
                          `*Time:* ${schedule.startTime} - ${schedule.endTime}\n` +
                          `*Priority:* ${schedule.priority || 'N/A'}`;

            if (schedule.address) message += `\n*📍 Address:* ${schedule.address}`;
            if (schedule.vehicle) message += `\n*🚚 Vehicle:* ${schedule.vehicle}`;
            if (crewLeader) message += `\n*👷‍♂️ Leader:* ${crewLeader.name}`;
            
            message += `\n\n*👥 Assigned Crew:*\n${assignedUsersText}\n\n` +
                       `*📝 Notes:*\n${schedule.notes || 'No notes provided.'}`;
                       
            if (schedule.materialsUsed) {
                let materialsText = '';
                if (Array.isArray(schedule.materialsUsed)) {
                    materialsText = schedule.materialsUsed.map(m => `  - ${m.quantity} x ${m.itemName}`).join('\n');
                } else if (typeof schedule.materialsUsed === 'string') {
                    materialsText = schedule.materialsUsed;
                }
                if (materialsText) {
                    message += `\n\n*🛠️ Materials:*\n${materialsText}`;
                }
            }

            const modalHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Share to WhatsApp</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <textarea id="whatsapp-message" class="w-full border rounded-md p-2 h-64">${message.trim()}</textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button id="refine-whatsapp-btn" class="btn btn-secondary">✨ Refine with AI</button>
                    <button id="send-whatsapp-btn" class="btn btn-primary !bg-green-500">Send Now</button>
                </div>
            `;
            showModal(modalHTML);
            feather.replace();

            document.getElementById('refine-whatsapp-btn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                const messageTextarea = document.getElementById('whatsapp-message');
                const currentMessage = messageTextarea.value;
                const prompt = `Rewrite the following crew schedule message to be more professional, friendly, and clear for a cargo team. Keep the essential details but improve the tone and formatting. Here is the message: \n\n"${currentMessage}"`;

                btn.textContent = 'Refining...';
                btn.disabled = true;

                try {
                    const refinedMessage = await callGeminiAPI(prompt);
                    messageTextarea.value = refinedMessage;
                } catch(error) {
                    console.error("Gemini API error:", error);
                    showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Could not refine message. Please try again.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                    feather.replace();
                } finally {
                    btn.textContent = '✨ Refine with AI';
                    btn.disabled = false;
                }
            });

            document.getElementById('send-whatsapp-btn').addEventListener('click', () => {
                const finalMessage = document.getElementById('whatsapp-message').value;
                const encodedMessage = encodeURIComponent(finalMessage);
                window.open(`https://api.whatsapp.com/send?text=${encodedMessage}`, '_blank');
                hideModal();
            });
        }

        // --- GEMINI API --- //
        async function callGeminiAPI(prompt) {
            const apiKey = ""; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status}`);
            }

            const result = await response.json();
            return result.candidates[0].content.parts[0].text;
        }

        function renderVehicles() {
            const container = document.getElementById('vehicle-list-container');
            if (!container) return;
            container.innerHTML = (window.appState.vehicles || []).map(vehicle => `
                <details class="bg-gray-50 rounded-lg border">
                    <summary class="flex justify-between items-center p-3 cursor-pointer">
                        <div>
                            <p class="font-semibold text-gray-900">${vehicle.name} (${vehicle.model})</p>
                            <p class="text-sm text-gray-600">${vehicle.licensePlate}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <button class="add-log-btn btn btn-success !p-2" data-id="${vehicle.id}"><i data-feather="plus"></i></button>
                             <button class="edit-vehicle-btn text-blue-500 hover:text-blue-700 p-2" data-id="${vehicle.id}"><i data-feather="edit-2"></i></button>
                             <button class="delete-vehicle-btn text-red-500 hover:text-red-700 p-2" data-id="${vehicle.id}"><i data-feather="trash-2"></i></button>
                        </div>
                    </summary>
                    <div class="p-3 border-t bg-white">
                        <div id="logs-for-${vehicle.id}" class="space-y-2">Loading logs...</div>
                    </div>
                </details>
            `).join('') || '<p class="text-center text-gray-500 py-4">No vehicles added yet.</p>';
            
            feather.replace();

            document.querySelectorAll('.add-log-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); showMaintenanceLogModal(e.currentTarget.dataset.id); }));
            document.querySelectorAll('.edit-vehicle-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); const v = window.appState.vehicles.find(v => v.id === e.currentTarget.dataset.id); showVehicleModal(v); }));
            document.querySelectorAll('.delete-vehicle-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); showConfirmationModal('Delete this vehicle and all its logs?', () => deleteVehicle(e.currentTarget.dataset.id)); }));

            // Load maintenance logs when a vehicle details section is opened
            document.querySelectorAll('#maintenance-tab details').forEach(detail => {
                detail.addEventListener('toggle', async (event) => {
                    if (event.target.open) {
                        const vehicleId = event.target.querySelector('.add-log-btn').dataset.id;
                        const logsContainer = document.getElementById(`logs-for-${vehicleId}`);
                        const logsQuery = query(collection(db, `${dataPath}/vehicles/${vehicleId}/maintenanceLogs`), orderBy('date', 'desc'));
                        const logSnapshot = await getDocs(logsQuery);
                        const logs = logSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        logsContainer.innerHTML = logs.map(log => `
                            <div class="flex justify-between items-center p-2 border-b">
                                <div>
                                    <p class="font-medium">${log.serviceType} on ${log.date}</p>
                                    <p class="text-sm text-gray-600">${log.notes || 'No notes.'} (Cost: $${log.cost || 0})</p>
                                </div>
                                <button class="delete-log-btn text-red-500 hover:text-red-700 p-1" data-vehicle-id="${vehicleId}" data-log-id="${log.id}"><i data-feather="x-circle"></i></button>
                            </div>
                        `).join('') || '<p class="text-sm text-gray-500">No maintenance logs yet.</p>';
                        feather.replace();
                        logsContainer.querySelectorAll('.delete-log-btn').forEach(btn => btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const { vehicleId, logId } = e.currentTarget.dataset;
                            showConfirmationModal('Delete this log entry?', () => deleteMaintenanceLog(vehicleId, logId));
                        }));
                    }
                });
            });
        }

        function showVehicleModal(vehicleToEdit = null) {
            const modalTitle = vehicleToEdit ? 'Edit Vehicle' : 'Add New Vehicle';
            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">${modalTitle}</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="vehicle-modal-form" class="space-y-4">
                    <input type="hidden" name="id" value="${vehicleToEdit?.id || ''}">
                    <div><label class="block text-sm font-medium mb-1">Vehicle Name/Identifier</label><input type="text" name="name" required class="w-full border rounded-md p-2" value="${vehicleToEdit?.name || ''}"></div>
                    <div><label class="block text-sm font-medium mb-1">Model</label><input type="text" name="model" class="w-full border rounded-md p-2" value="${vehicleToEdit?.model || ''}"></div>
                    <div><label class="block text-sm font-medium mb-1">License Plate</label><input type="text" name="licensePlate" required class="w-full border rounded-md p-2" value="${vehicleToEdit?.licensePlate || ''}"></div>
                    <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary">Save Vehicle</button>
                    </div>
                </form>
            `;
            showModal(modalHTML);
            feather.replace();
            document.getElementById('vehicle-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const id = formData.get('id');
                const vehicleData = Object.fromEntries(formData.entries());
                delete vehicleData.id;
                if (id) { await updateVehicle(id, vehicleData); } 
                else { await addVehicle(vehicleData); }
                hideModal();
            });
        }

        function showMaintenanceLogModal(vehicleId) {
            const modalHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">Add Maintenance Log</h2>
                    <button class="close-modal-btn p-2 rounded-full hover:bg-gray-200"><i data-feather="x"></i></button>
                </div>
                <form id="log-modal-form" class="space-y-4">
                    <input type="hidden" name="vehicleId" value="${vehicleId}">
                    <div><label class="block text-sm font-medium mb-1">Date of Service</label><input type="date" name="date" required class="w-full border rounded-md p-2"></div>
                    <div><label class="block text-sm font-medium mb-1">Service Type</label><input type="text" name="serviceType" required class="w-full border rounded-md p-2" placeholder="e.g., Oil Change, Tire Rotation"></div>
                    <div><label class="block text-sm font-medium mb-1">Cost</label><input type="number" name="cost" class="w-full border rounded-md p-2" min="0" step="0.01"></div>
                    <div><label class="block text-sm font-medium mb-1">Notes</label><textarea name="notes" class="w-full border rounded-md p-2 h-24"></textarea></div>
                    <div class="flex justify-end gap-4 !mt-6">
                       <button type="button" class="close-modal-btn btn btn-secondary">Cancel</button>
                       <button type="submit" class="btn btn-primary">Save Log</button>
                    </div>
                </form>
            `;
            showModal(modalHTML);
            feather.replace();
            document.getElementById('log-modal-form').querySelector('[name="date"]').value = new Date().toISOString().split('T')[0];
            document.getElementById('log-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const vId = formData.get('vehicleId');
                const logData = Object.fromEntries(formData.entries());
                delete logData.vehicleId;
                await addMaintenanceLog(vId, logData);
                hideModal();
            });
        }

        // --- MAIN APP LOGIC --- //
        window.appState = { users: [], inventory: [], schedules: [], roles: [], impersonatedUser: null, pendingUsers: [], vehicles: [] };

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            
            const tabToShow = document.getElementById(`${tabId}-tab`);
            if (tabToShow) {
                tabToShow.classList.remove('hidden');
            }
            
            const activeLink = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
            if(activeLink) {
                 activeLink.classList.add('active');
                 const title = tabId === 'admin' ? 'Admin Panel' : activeLink.textContent;
                 document.getElementById('tab-title').textContent = title;
            }

            if (tabId === 'analytics') { 
                initCharts(); 
            }
            if (tabId === 'reports') {
                const select = document.getElementById('material-usage-select');
                if(select) {
                    select.innerHTML = '<option value="">-- Select an Item --</option>' + 
                        window.appState.inventory.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                }
            }
        }
        
        function exportToCsv(filename, rows) {
            const processRow = (row) => row.map(val => {
                let finalVal = (val === null || val === undefined) ? '' : String(val);
                if (/[",\n]/.test(finalVal)) {
                    finalVal = `"${finalVal.replace(/"/g, '""')}"`;
                }
                return finalVal;
            }).join(',');

            const csvContent = "data:text/csv;charset=utf-8," 
                + rows.map(processRow).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // AUTHENTICATION EVENT LISTENERS
            const loginCard = document.getElementById('login-card');
            const registerCard = document.getElementById('register-card');
            const pendingCard = document.getElementById('pending-approval-card');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');
            const backToLoginBtn = document.getElementById('back-to-login');

            showRegisterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginCard.classList.add('hidden');
                registerCard.classList.remove('hidden');
            });
            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                registerCard.classList.add('hidden');
                loginCard.classList.remove('hidden');
            });
            backToLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                pendingCard.classList.add('hidden');
                loginCard.classList.remove('hidden');
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                const errorEl = document.getElementById('login-error');
                try {
                    errorEl.textContent = '';
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    errorEl.textContent = "Invalid email or password.";
                }
            });

             document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                 const errorEl = document.getElementById('register-error');
                try {
                    errorEl.textContent = '';
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await setDoc(doc(db, "registrations", user.uid), {
                        email: user.email,
                        status: "pending",
                        createdAt: serverTimestamp()
                    });
                    
                    await signOut(auth);
                    
                    registerCard.classList.add('hidden');
                    pendingCard.classList.remove('hidden');
                    feather.replace();

                } catch (error) {
                    errorEl.textContent = error.message;
                }
            });

            document.getElementById('logout-btn').addEventListener('click', async () => {
                await signOut(auth);
            });

            // MAIN APP EVENT LISTENERS
            document.getElementById('analytics-tab').innerHTML = AnalyticsTemplate;
            document.getElementById('scheduling-tab').innerHTML = SchedulingTemplate;
            document.getElementById('inventory-tab').innerHTML = InventoryTemplate;
            document.getElementById('reports-tab').innerHTML = ReportsTemplate;
            document.getElementById('maintenance-tab').innerHTML = MaintenanceTemplate;
            document.getElementById('admin-tab').innerHTML = AdminTemplate;
            document.getElementById('notifications-tab').innerHTML = NotificationsTemplate;
            document.getElementById('testing-tab').innerHTML = TestingTemplate;
            
            initFirebase().then(() => {
                feather.replace(); 
                
                // Initialize testing tool - simple version
                setTimeout(() => {
                    if (typeof updateTestReportsList === 'function') {
                        updateTestReportsList();
                    }
                }, 100);
                
                if(document.getElementById('schedule-date')) {
                    document.getElementById('schedule-date').value = new Date().toISOString().split('T')[0];
                }
                const sidebar = document.getElementById('sidebar');
                document.getElementById('menu-toggle').addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        switchTab(e.currentTarget.dataset.tab);
                        if (window.innerWidth < 1024) { 
                            sidebar.classList.add('-translate-x-full'); 
                        }
                    });
                });
                setupModalEventListeners();
                document.getElementById('add-role-btn')?.addEventListener('click', () => showRoleModal());
                document.getElementById('add-crew-btn')?.addEventListener('click', () => showUserModal());
                document.getElementById('add-schedule-btn').addEventListener('click', () => showScheduleModal());
                document.getElementById('add-inventory-btn').addEventListener('click', handleAddInventory);
                document.getElementById('add-vehicle-btn')?.addEventListener('click', () => showVehicleModal());
                document.getElementById('schedule-date').addEventListener('change', (e) => attachScheduleListener(e.target.value));
                document.getElementById('inventory-search').addEventListener('input', renderInventory);
                document.getElementById('send-notification-form')?.addEventListener('submit', handleSendNotification);
                document.getElementById('refresh-notifications-btn')?.addEventListener('click', () => {
                    // Re-attach notifications listener to refresh
                    attachNotificationsListener();
                });
                document.getElementById('clear-notifications-btn')?.addEventListener('click', () => {
                    showConfirmationModal('Are you sure you want to clear all notifications?', async () => {
                        try {
                            const notificationsRef = collection(db, `${dataPath}/notifications`);
                            const snapshot = await getDocs(notificationsRef);
                            const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                            await Promise.all(deletePromises);
                        } catch (error) {
                            console.error('Error clearing notifications:', error);
                        }
                    });
                });

                // --- REPORTING EVENT LISTENERS --- //
                document.getElementById('pdf-inventory-report')?.addEventListener('click', () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.autoTable({
                        head: [['Item Name', 'SKU', 'Quantity']],
                        body: window.appState.inventory.map(item => [item.name, item.sku || 'N/A', item.quantity]),
                    });
                    doc.save('inventory-report.pdf');
                });
                document.getElementById('excel-inventory-report')?.addEventListener('click', () => {
                    const rows = [
                        ['Item Name', 'SKU', 'Quantity'],
                        ...window.appState.inventory.map(item => [item.name, item.sku || 'N/A', item.quantity])
                    ];
                    exportToCsv('inventory-report.csv', rows);
                });
                document.getElementById('generate-job-report')?.addEventListener('click', async () => {
                    const startDate = document.getElementById('report-start-date').value;
                    const endDate = document.getElementById('report-end-date').value;
                    if (!startDate || !endDate) {
                        showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Please select a start and end date.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                        feather.replace();
                        return;
                    }
                    const q = query(collection(db, `${dataPath}/schedules`), where('date', '>=', startDate), where('date', '<=', endDate));
                    const snapshot = await getDocs(q);
                    const jobs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    
                    if(jobs.length === 0) {
                        document.getElementById('job-report-container').innerHTML = `<p class="text-center text-gray-500 py-4">No jobs found in this date range.</p>`;
                        document.getElementById('job-report-actions').classList.add('hidden');
                        return;
                    }

                    const tableRows = jobs.map(job => `
                        <tr>
                            <td class="py-2 px-3">${job.date}</td>
                            <td class="py-2 px-3">${job.task}</td>
                            <td class="py-2 px-3">${job.status}</td>
                        </tr>
                    `).join('');

                    document.getElementById('job-report-container').innerHTML = `
                        <table class="min-w-full bg-white text-sm">
                            <thead class="bg-gray-50"><tr>
                                <th class="py-2 px-3 text-left font-medium">Date</th>
                                <th class="py-2 px-3 text-left font-medium">Task</th>
                                <th class="py-2 px-3 text-left font-medium">Status</th>
                            </tr></thead>
                            <tbody class="divide-y">${tableRows}</tbody>
                        </table>
                    `;
                    document.getElementById('job-report-actions').classList.remove('hidden');

                    document.getElementById('pdf-job-report').onclick = () => {
                         const { jsPDF } = window.jspdf;
                         const doc = new jsPDF();
                         doc.autoTable({
                            head: [['Date', 'Task', 'Status']],
                            body: jobs.map(j => [j.date, j.task, j.status])
                         });
                         doc.save('job-report.pdf');
                    };
                    document.getElementById('excel-job-report').onclick = () => {
                        const rows = [['Date', 'Task', 'Status'], ...jobs.map(j => [j.date, j.task, j.status])];
                        exportToCsv('job-report.csv', rows);
                    };
                });


                document.getElementById('generate-material-report-btn')?.addEventListener('click', async () => {
                    const itemId = document.getElementById('material-usage-select').value;
                    if (!itemId) {
                        showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Please select a material first.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                        feather.replace();
                        return;
                    }

                    const container = document.getElementById('material-usage-report-container');
                    container.innerHTML = `<p class="text-center">Generating report...</p>`;

                    const q = query(collection(db, `${dataPath}/schedules`));
                    const querySnapshot = await getDocs(q);
                    
                    const usage = [];
                    querySnapshot.forEach(doc => {
                        const schedule = doc.data();
                        if (Array.isArray(schedule.materialsUsed)) {
                            schedule.materialsUsed.forEach(material => {
                                if (material.itemId === itemId) {
                                    usage.push({
                                        date: schedule.date,
                                        task: schedule.task,
                                        quantity: material.quantity
                                    });
                                }
                            });
                        }
                    });

                    if (usage.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 py-4">No usage found for this material.</p>`;
                        return;
                    }

                    const tableRows = usage.sort((a,b) => new Date(b.date) - new Date(a.date)).map(u => `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${u.date}</td>
                            <td class="py-3 px-4">${u.task}</td>
                            <td class="py-3 px-4 text-center font-semibold">${u.quantity}</td>
                        </tr>
                    `).join('');

                    container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Job/Task</th>
                                        <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Quantity Used</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    `;

                });

                document.getElementById('generate-damage-report-btn')?.addEventListener('click', async () => {
                    const startDate = document.getElementById('damage-report-start-date').value;
                    const endDate = document.getElementById('damage-report-end-date').value;
                    if (!startDate || !endDate) {
                        showModal(`<div class="p-4 text-center"><p class="text-lg font-medium">Please select a start and end date.</p><div class="flex justify-center mt-6"><button class="close-modal-btn btn btn-primary">OK</button></div></div>`);
                        feather.replace();
                        return;
                    }
                     const container = document.getElementById('damage-report-container');
                    container.innerHTML = `<p class="text-center">Generating report...</p>`;

                    const q = query(collection(db, `${dataPath}/damagedItems`), where('date', '>=', startDate), where('date', '<=', endDate));
                    const snapshot = await getDocs(q);
                    const items = snapshot.docs.map(doc => doc.data());

                     if (items.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 py-4">No damaged items found in this date range.</p>`;
                        return;
                    }
                     const tableRows = items.map(item => `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4">${item.date}</td>
                            <td class="py-3 px-4">${item.itemName}</td>
                            <td class="py-3 px-4 text-center">${item.quantity}</td>
                        </tr>
                    `).join('');
                     container.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-50"><tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Item Name</th>
                                    <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase">Quantity Damaged</th>
                                </tr></thead>
                                <tbody class="divide-y divide-gray-200">${tableRows}</tbody>
                            </table>
                        </div>
                    `;
                });

                 // --- TESTING MODE EVENT LISTENERS --- //
                document.getElementById('generate-dummy-data-btn')?.addEventListener('click', handleGenerateDummyData);
                document.getElementById('clear-dummy-data-btn')?.addEventListener('click', handleClearDummyData);
                document.getElementById('run-system-check-btn')?.addEventListener('click', handleRunSystemCheck);
                document.getElementById('generate-test-report-btn')?.addEventListener('click', handleGenerateTestReport);
            });
        });

    </script>
</body>
</html>


